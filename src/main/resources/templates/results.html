<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Conditions Generated - Test Analyst AI Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container {
            padding-top: 30px;
            padding-bottom: 30px;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
            margin-bottom: 20px;
        }
        .card-header {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            text-align: center;
            padding: 20px;
        }
        .btn-primary {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            border: none;
            border-radius: 8px;
            padding: 12px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .btn-secondary {
            border-radius: 8px;
            padding: 12px 30px;
            font-weight: 600;
        }
        .test-conditions {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #4CAF50;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            max-height: 600px;
            overflow-y: auto;
        }
        .input-preview {
            background: #e9ecef;
            border-radius: 10px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            border-left: 4px solid #6c757d;
        }
        .section-title {
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .copy-btn:hover {
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .results-container {
            position: relative;
        }
        .back-to-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            display: none;
        }
        .back-to-top:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col-12">
                <!-- Header -->
                <div class="card">
                    <div class="card-header">
                        <h1 class="mb-0">
                            <i class="fas fa-check-circle"></i> Test Conditions Generated Successfully!
                        </h1>
                        <p class="mb-0 mt-2">AI-powered analysis complete</p>
                    </div>
                </div>

                <!-- Input Preview -->
                <div class="card">
                    <div class="card-body">
                        <h4 class="section-title">
                            <i class="fas fa-info-circle"></i> Input Analysis - <span th:text="${inputType}"></span>
                            <span th:if="${fileName}" class="badge bg-secondary ms-2" th:text="'File: ' + ${fileName}"></span>
                        </h4>
                        <div class="input-preview" th:text="${input}"></div>
                    </div>
                </div>

                <!-- Generated Test Conditions -->
                <div class="card">
                    <div class="card-body results-container">
                        <h4 class="section-title">
                            <i class="fas fa-list-check"></i> Generated Test Conditions
                        </h4>
                        <button class="copy-btn" onclick="copyToClipboard()">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                        <div class="test-conditions" id="testConditions" th:text="${testConditions}"></div>
                    </div>
                </div>

                <!-- Parsed Table View -->
                <div class="card" id="tableCard" style="display:none;">
                    <div class="card-body">
                        <h4 class="section-title">
                            <i class="fas fa-table"></i> Parsed Test Cases Table
                        </h4>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="resultsTable"></table>
                        </div>
                        <div class="text-muted" id="tableNotice" style="display:none;">No table detected in the generated content.</div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="card">
                    <div class="card-body text-center">
                        <a href="/" class="btn btn-primary me-3">
                            <i class="fas fa-plus"></i> Generate New Test Conditions
                        </a>
                        <button class="btn btn-secondary" onclick="downloadResults()">
                            <i class="fas fa-download"></i> Download as Text File
                        </button>
                        <button class="btn btn-outline-primary ms-3" onclick="printResults()">
                            <i class="fas fa-print"></i> Print Results
                        </button>
                        <button class="btn btn-success ms-3" onclick="exportToExcel()">
                            <i class="fas fa-file-excel"></i> Export to Excel
                        </button>
                        <button class="btn btn-outline-secondary ms-2" onclick="exportToCSV()">
                            <i class="fas fa-file-csv"></i> Export CSV
                        </button>
                    </div>
                </div>

                <!-- Statistics -->
                <div class="card">
                    <div class="card-body">
                        <h5 class="section-title">
                            <i class="fas fa-chart-bar"></i> Analysis Statistics
                        </h5>
                        <div class="row text-center">
                            <div class="col-md-3">
                                <div class="mb-2">
                                    <i class="fas fa-file-alt fa-2x text-primary"></i>
                                </div>
                                <h6>Input Type</h6>
                                <p class="text-muted" th:text="${inputType}"></p>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-2">
                                    <i class="fas fa-clock fa-2x text-success"></i>
                                </div>
                                <h6>Processing Time</h6>
                                <p class="text-muted">~3-5 seconds</p>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-2">
                                    <i class="fas fa-tasks fa-2x text-warning"></i>
                                </div>
                                <h6>Test Categories</h6>
                                <p class="text-muted">Multiple types generated</p>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-2">
                                    <i class="fas fa-robot fa-2x text-info"></i>
                                </div>
                                <h6>AI Model</h6>
                                <p class="text-muted">ChatGPT-3.5-turbo</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Back to Top Button -->
    <button class="back-to-top" onclick="scrollToTop()">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!-- Toast for Copy Notification -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="copyToast" class="toast hide" role="alert">
            <div class="toast-header">
                <i class="fas fa-check-circle text-success me-2"></i>
                <strong class="me-auto">Success</strong>
            </div>
            <div class="toast-body">
                Test conditions copied to clipboard!
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Copy to clipboard functionality
        function copyToClipboard() {
            const testConditions = document.getElementById('testConditions').textContent;
            navigator.clipboard.writeText(testConditions).then(function() {
                showToast();
            }).catch(function(err) {
                console.error('Could not copy text: ', err);
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = testConditions;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast();
            });
        }

        // Show toast notification
        function showToast() {
            const toast = new bootstrap.Toast(document.getElementById('copyToast'));
            toast.show();
        }

        // Download results as text file
        function downloadResults() {
            const testConditions = document.getElementById('testConditions').textContent;
            const inputType = /*[[${inputType}]]*/ 'Analysis';
            const timestamp = new Date().toISOString().split('T')[0];

            const content = `Test Conditions Generated by AI Assistant
Generated on: ${new Date().toLocaleString()}
Input Type: ${inputType}

${testConditions}`;

            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `test-conditions-${timestamp}.txt`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        // Print results
        function printResults() {
            const testConditions = document.getElementById('testConditions').textContent;
            const inputType = /*[[${inputType}]]*/ 'Analysis';

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Test Conditions Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { border-bottom: 2px solid #4CAF50; padding-bottom: 10px; margin-bottom: 20px; }
                        .content { white-space: pre-wrap; font-family: 'Courier New', monospace; }
                        .meta { color: #666; margin-bottom: 20px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Test Conditions Report</h1>
                        <div class="meta">
                            <p>Generated on: ${new Date().toLocaleString()}</p>
                            <p>Input Type: ${inputType}</p>
                            <p>Generated by: Test Analyst AI Assistant</p>
                        </div>
                    </div>
                    <div class="content">${testConditions}</div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Markdown table parsing and rendering
        let parsedTableData = null; // Array of arrays, including header row

        function parseMarkdownTable(md) {
            if (!md) return null;
            // Remove code fences if present
            md = md.replace(/```[a-zA-Z]*\n?|```/g, '');
            const lines = md.split('\n').map(l => l.trim());
            // Find a header row followed by a delimiter row
            for (let i = 0; i < lines.length - 1; i++) {
                const headerLine = lines[i];
                const delimLine = lines[i + 1];
                if (!headerLine.startsWith('|') || !delimLine.startsWith('|')) continue;
                if (!/^\|?\s*:?[-\s|:]+:?\s*\|?$/.test(delimLine)) continue;
                const headers = headerLine.split('|').map(c => c.trim()).filter(c => c.length > 0);
                const rows = [];
                for (let j = i + 2; j < lines.length; j++) {
                    const rowLine = lines[j];
                    if (!rowLine || !rowLine.includes('|')) break;
                    if (!rowLine.startsWith('|')) break;
                    const cells = rowLine.split('|').map(c => c.trim()).filter((_, idx, arr) => true);
                    const cleaned = cells.filter(c => c.length > 0);
                    if (cleaned.length === 0) continue;
                    rows.push(cleaned);
                }
                if (headers.length > 0 && rows.length > 0) {
                    return { headers, rows };
                }
            }
            return null;
        }

        function renderTable(parsed) {
            const card = document.getElementById('tableCard');
            const notice = document.getElementById('tableNotice');
            const table = document.getElementById('resultsTable');
            if (!parsed) {
                card.style.display = 'block';
                notice.style.display = 'block';
                table.innerHTML = '';
                parsedTableData = null;
                return;
            }
            notice.style.display = 'none';
            card.style.display = 'block';

            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            parsed.headers.forEach(h => {
                const th = document.createElement('th');
                th.textContent = h;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);

            const tbody = document.createElement('tbody');
            parsed.rows.forEach(r => {
                const tr = document.createElement('tr');
                parsed.headers.forEach((_, idx) => {
                    const td = document.createElement('td');
                    td.textContent = r[idx] !== undefined ? r[idx] : '';
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });

            table.innerHTML = '';
            table.appendChild(thead);
            table.appendChild(tbody);

            parsedTableData = [parsed.headers, ...parsed.rows];
        }

        function exportToExcel() {
            if (!parsedTableData) {
                alert('No parsed table available to export.');
                return;
            }
            const ws = XLSX.utils.aoa_to_sheet(parsedTableData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'TestCases');
            const ts = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `test-cases-${ts}.xlsx`);
        }

        function exportToCSV() {
            if (!parsedTableData) {
                alert('No parsed table available to export.');
                return;
            }
            const ws = XLSX.utils.aoa_to_sheet(parsedTableData);
            const csv = XLSX.utils.sheet_to_csv(ws);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `test-cases-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Back to top functionality
        window.addEventListener('scroll', function() {
            const backToTop = document.querySelector('.back-to-top');
            if (window.pageYOffset > 300) {
                backToTop.style.display = 'block';
            } else {
                backToTop.style.display = 'none';
            }
        });

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Add some visual enhancements and attempt to parse table on load
        document.addEventListener('DOMContentLoaded', function() {
            // Animate the results appearance
            const cards = document.querySelectorAll('.card');
            cards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    card.style.transition = 'all 0.5s ease';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 200);
            });

            // Try to parse markdown table from generated content
            const md = document.getElementById('testConditions').textContent;
            const parsed = parseMarkdownTable(md);
            renderTable(parsed);
        });
    </script>
</body>
</html>
