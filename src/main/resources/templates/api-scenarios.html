<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Scenarios</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet"/>
</head>
<body class="bg-light">
<div class="container py-4">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-plug"></i> API Scenarios</h5>
            <div class="ms-2 small">Click a row to view Rest Assured code</div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped align-middle">
                    <thead>
                    <tr>
                        <th>Title</th>
                        <th>Expected</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="sc : ${scenarios}" class="scenario-row" th:attr="data-id=${sc.id}">
                        <td th:text="${sc.title}"></td>
                        <td th:text="${sc.expectedStatus}">-</td>
                        <td class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-primary" th:attr="data-id=${sc.id}" onclick="runScenario(this)">
                                <i class="fas fa-play"></i> Run
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" th:attr="data-id=${sc.id}" onclick="viewCode(this)">
                                <i class="fas fa-code"></i> Code
                            </button>
                            <button class="btn btn-sm btn-outline-info" th:attr="data-id=${sc.id}" onclick="viewRequest(this)">
                                <i class="fas fa-file-alt"></i> Request
                            </button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div class="row g-3 mt-1">
                <div class="col-md-7">
                    <div id="result" style="display:none;">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-terminal"></i> Response</span>
                                <div class="small" id="meta"></div>
                            </div>
                            <div class="card-body">
                                <div class="mb-2"><span class="badge text-bg-secondary" id="contentType">-</span> <span class="badge text-bg-info" id="statusBadge">-</span> <span class="badge text-bg-light text-dark" id="timeBadge">-</span></div>
                                <pre class="mb-2"><code id="resultText" class="language-json" style="max-height: 420px; overflow:auto; display:block;"></code></pre>
                                <details>
                                    <summary>Headers</summary>
                                    <pre class="mb-0"><code id="headersText" class="language-json" style="max-height: 200px; overflow:auto; display:block;"></code></pre>
                                </details>
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-outline-success" id="btnAssert">Add/Update Expected Assertion</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-5">
                    <div id="codePanel" style="display:none;">
                        <div class="card h-100">
                            <div class="card-header"><i class="fas fa-code"></i> Rest Assured</div>
                            <div class="card-body">
                                <pre class="language-java" style="max-height: 540px; overflow:auto;"><code id="codeText" class="language-java"></code></pre>
                            </div>
                        </div>
                    </div>
                    <div id="requestPanel" style="display:none;" class="mt-3">
                        <div class="card h-100">
                            <div class="card-header"><i class="fas fa-file-alt"></i> Request Details</div>
                            <div class="card-body">
                                <div class="mb-2"><span class="badge text-bg-dark" id="reqMethod">-</span> <code id="reqUrl">-</code></div>
                                <details open>
                                    <summary>Headers</summary>
                                    <pre class="mb-2"><code id="reqHeaders" class="language-json" style="max-height: 200px; overflow:auto; display:block;"></code></pre>
                                </details>
                                <details>
                                    <summary>Body</summary>
                                    <pre class="mb-0"><code id="reqBody" class="language-json" style="max-height: 260px; overflow:auto; display:block;"></code></pre>
                                </details>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="text-center mt-3">
                <a href="/" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Back</a>
            </div>
        </div>
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
<script th:inline="none">
    let currentScenarioId = null;
    async function runScenario(btn) {
        const id = btn.getAttribute('data-id');
        currentScenarioId = id;
        const res = await fetch('/api/run-scenario', { method: 'POST', headers: {'Content-Type': 'application/x-www-form-urlencoded'}, body: 'id=' + encodeURIComponent(id)});
        const json = await res.json();
        renderResponse(json);
    }

    function renderResponse(json) {
        const container = document.getElementById('result');
        const contentType = (json.contentType || '').toLowerCase();
        const statusBadge = document.getElementById('statusBadge');
        const ctBadge = document.getElementById('contentType');
        const timeBadge = document.getElementById('timeBadge');
        const headersPre = document.getElementById('headersText');

        // Pretty print JSON or XML; otherwise raw
        let bodyOut = json.body || '';
        if (contentType.includes('json')) {
            try { bodyOut = JSON.stringify(JSON.parse(bodyOut), null, 2); } catch {}
        } else if (contentType.includes('xml') || bodyOut.trim().startsWith('<')) {
            bodyOut = formatXml(bodyOut);
        }
        const isXml = bodyOut.trim().startsWith('<');
        const resultEl = document.getElementById('resultText');
        resultEl.className = isXml ? 'language-markup' : 'language-json';
        resultEl.textContent = bodyOut;
        Prism.highlightElement(resultEl);
        ctBadge.textContent = json.contentType || '-';
        statusBadge.textContent = 'HTTP ' + (json.httpStatus ?? '-');
        timeBadge.textContent = (json.timeMs != null ? json.timeMs + ' ms' : '');
        headersPre.textContent = JSON.stringify(json.headers || {}, null, 2);
        Prism.highlightElement(headersPre);
        container.style.display = 'block';
        resultEl.scrollIntoView({ behavior: 'smooth' });

        // Wire assertion button to current scenario id if available in table row
        document.getElementById('btnAssert').onclick = () => openAssertModal();
    }

    async function viewCode(btnOrRow) {
        const id = btnOrRow.getAttribute('data-id');
        currentScenarioId = id;
        const res = await fetch('/api/scenario-code?id=' + encodeURIComponent(id));
        const json = await res.json();
        if (json.status === 'ok') {
            const codeEl = document.getElementById('codeText');
            codeEl.textContent = json.code;
            Prism.highlightElement(codeEl);
            document.getElementById('codePanel').style.display = 'block';
            codeEl.scrollIntoView({ behavior: 'smooth' });
        }
    }

    async function viewRequest(btnOrRow) {
        const id = btnOrRow.getAttribute('data-id');
        currentScenarioId = id;
        const res = await fetch('/api/scenario-detail?id=' + encodeURIComponent(id));
        const json = await res.json();
        if (json.status === 'ok') {
            document.getElementById('reqMethod').textContent = (json.method || 'GET');
            document.getElementById('reqUrl').textContent = json.url || '-';
            const reqHeaders = document.getElementById('reqHeaders');
            reqHeaders.textContent = JSON.stringify(json.headers || {}, null, 2);
            Prism.highlightElement(reqHeaders);
            let body = json.body || '';
            const looksJson = body.trim().startsWith('{') || body.trim().startsWith('[');
            if (looksJson) { try { body = JSON.stringify(JSON.parse(body), null, 2); } catch (e) {} }
            else if (body.trim().startsWith('<')) { body = formatXml(body); }
            const reqBody = document.getElementById('reqBody');
            reqBody.className = body.trim().startsWith('<') ? 'language-markup' : 'language-json';
            reqBody.textContent = body;
            Prism.highlightElement(reqBody);
            document.getElementById('requestPanel').style.display = 'block';
            document.getElementById('requestPanel').scrollIntoView({ behavior: 'smooth' });
        }
    }

    // Make entire row clickable to open request details
    document.querySelectorAll('.scenario-row').forEach(r => {
        r.addEventListener('click', (e) => {
            if (e.target.closest('button')) return; // ignore if a button was clicked
            currentScenarioId = r.getAttribute('data-id');
            viewRequest(r);
        });
    });

    function formatXml(xml) {
        try {
            let PADDING = '  '; // two spaces
            let reg = /(>)(<)(\/*)/g;
            xml = xml.replace(reg, '$1\n$2$3');
            let pad = 0; let formatted = '';
            xml.split('\n').forEach((node) => {
                if (!node) return;
                let indent = 0;
                if (node.match(/.+<\/\w[^>]*>$/)) {
                    indent = 0;
                } else if (node.match(/^<\/\w/)) {
                    if (pad !== 0) pad -= 1;
                } else if (node.match(/^<\w([^>]*[^\/])?>.*$/)) {
                    indent = 1;
                }
                formatted += PADDING.repeat(pad) + node + '\n';
                pad += indent;
            });
            return formatted.trim();
        } catch { return xml; }
    }

    // Assertion modal logic
    function openAssertModal() {
        if (!currentScenarioId) return;
        if (confirm('Is this the expected response?')) {
            updateAssertion(currentScenarioId, '');
            return;
        }
        const expected = prompt('Type the expected text that should be present in response body:');
        if (expected == null) return;
        updateAssertion(currentScenarioId, expected);
    }

    async function updateAssertion(id, expected) {
        const params = new URLSearchParams();
        params.set('id', id);
        params.set('expected', expected);
        const res = await fetch('/api/scenario-assert', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: params.toString() });
        const json = await res.json();
        if (json.status === 'ok') {
            // refresh code panel to include assertion
            const codeRes = await fetch('/api/scenario-code?id=' + encodeURIComponent(id));
            const codeJson = await codeRes.json();
            if (codeJson.status === 'ok') {
                const codeEl = document.getElementById('codeText');
                codeEl.textContent = codeJson.code;
                Prism.highlightElement(codeEl);
                document.getElementById('codePanel').style.display = 'block';
            }
        }
    }
</script>
</body>
</html>