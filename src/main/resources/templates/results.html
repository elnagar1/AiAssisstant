<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Results Generated - Test Analyst AI Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0b1220 0%, #020617 100%);
            min-height: 100vh;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            color: #e5e7eb;
        }
        .page-container { padding: 24px 12px; }
        .card-glass {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,.4);
            color: #e5e7eb;
        }
        .card-header-gradient {
            background: linear-gradient(45deg, #22c55e, #3b82f6);
            color: #fff;
            border-radius: 16px 16px 0 0 !important;
            padding: 20px;
            text-align: center;
        }
        .section-title { border-bottom: 1px solid #334155; padding-bottom: 10px; margin-bottom: 16px; color: #e2e8f0; }
        .input-preview { background: #0b1220; border-left: 4px solid #3b82f6; border-radius: 12px; padding: 16px; white-space: pre-wrap; color: #e5e7eb; }
        .copy-btn { position: absolute; top: 10px; right: 10px; }
        .result-badge { font-size: .8rem; }
        .result-card-title { display: flex; align-items: center; gap: 8px; }
        .table { color: #e5e7eb; table-layout: fixed !important; width: 100% !important; }
        .table thead th { background: #0f172a; color: #cbd5e1; border-color: #334155; }
        .table tbody td { border-color: #334155; word-wrap: break-word; overflow-wrap: break-word; }
        /* Column width controls for better layout - Force fixed widths */
        .table th:nth-child(1), .table td:nth-child(1) { width: 15% !important; min-width: 100px !important; max-width: 150px !important; }
        .table th:nth-child(2), .table td:nth-child(2) { width: 25% !important; min-width: 150px !important; max-width: 250px !important; }
        .table th:nth-child(3), .table td:nth-child(3) { width: 20% !important; min-width: 120px !important; max-width: 200px !important; }
        .table th:nth-child(4), .table td:nth-child(4) { width: 20% !important; min-width: 120px !important; max-width: 200px !important; }
        .table th:nth-child(5), .table td:nth-child(5) { width: 20% !important; min-width: 120px !important; max-width: 200px !important; }
        /* For tables with more than 5 columns, use equal distribution */
        .table th:nth-child(n+6), .table td:nth-child(n+6) { width: auto !important; min-width: 100px !important; max-width: 150px !important; }
        /* Text truncation for long content - Force truncation */
        .table td { max-width: 0 !important; overflow: hidden !important; text-overflow: ellipsis !important; white-space: nowrap !important; }
        .table td:hover { white-space: normal !important; overflow: visible !important; position: relative !important; z-index: 1 !important; background: #0f172a !important; }
        /* Prevent table from expanding */
        .table-responsive { overflow-x: auto !important; }
        .table-responsive .table { min-width: 100% !important; }
        
        /* Fix Canvas Charts sizing issues */
        .chart-container { 
            max-height: 400px !important; 
            overflow: hidden !important; 
            position: relative !important;
        }
        .chart-container canvas { 
            max-width: 100% !important; 
            max-height: 400px !important; 
            width: auto !important; 
            height: auto !important;
            display: block !important;
        }
        .compact-chart { 
            max-height: 300px !important; 
            overflow: hidden !important;
        }
        .compact-chart canvas { 
            max-height: 300px !important; 
            max-width: 100% !important;
        }
        /* Force chart containers to have fixed dimensions */
        #statusChart, #issueTypesChart {
            max-height: 350px !important;
            overflow: hidden !important;
        }
        #statusChartCanvas, #issueTypesChartCanvas {
            max-height: 350px !important;
            max-width: 100% !important;
            width: auto !important;
            height: auto !important;
        }
        .pill { display: inline-block; padding: 4px 10px; border-radius: 999px; font-size: .8rem; color: #e5e7eb; background: rgba(51,65,85,.6); margin-right: 6px; }
        .form-select, .form-control { background-color: #0f172a; color: #e5e7eb; border-color: #334155; }
        .form-select:focus, .form-control:focus { background-color: #0f172a; color: #e5e7eb; border-color: #3b82f6; box-shadow: 0 0 0 .2rem rgba(59,130,246,.25); }
        .btn-outline-secondary { color: #e5e7eb; border-color: #475569; }
        .btn-outline-secondary:hover { background: #1f2937; color: #fff; }
        .btn-outline-primary { color: #93c5fd; border-color: #60a5fa; }
        .btn-outline-primary:hover { background: #1d4ed8; color: #fff; }
        .btn-success { background: #16a34a; border-color: #16a34a; }
        .btn-primary { background: #2563eb; border-color: #2563eb; }
        .row-selected { outline: 2px solid #22c55e; background: rgba(34,197,94,.1); }
        /* Mobile responsiveness for tables */
        @media (max-width: 768px) {
            .table-responsive { font-size: 0.875rem; }
            .table th, .table td { padding: 0.5rem 0.25rem; }
            .table th:nth-child(1), .table td:nth-child(1) { width: 20%; }
            .table th:nth-child(2), .table td:nth-child(2) { width: 30%; }
            .table th:nth-child(3), .table td:nth-child(3) { width: 25%; }
            .table th:nth-child(4), .table td:nth-child(4) { width: 25%; }
            .table th:nth-child(n+5), .table td:nth-child(n+5) { display: none; }
            
            /* Mobile chart responsiveness */
            .chart-container, .compact-chart { max-height: 250px !important; }
            .chart-container canvas, .compact-chart canvas { max-height: 250px !important; }
        }
        
        @media (max-width: 576px) {
            .table th:nth-child(3), .table td:nth-child(3) { display: none; }
            .table th:nth-child(1), .table td:nth-child(1) { width: 30%; }
            .table th:nth-child(2), .table td:nth-child(2) { width: 70%; }
            
            /* Smaller charts on mobile */
            .chart-container, .compact-chart { max-height: 200px !important; }
            .chart-container canvas, .compact-chart canvas { max-height: 200px !important; }
        }
        
        /* RTL adjustments */
        [dir="rtl"] .section-title { text-align: right; }
        [dir="rtl"] .input-preview { text-align: right; }
        [dir="rtl"] .nav { justify-content: flex-end; }
        [dir="rtl"] .ms-1 { margin-left: 0 !important; margin-right: .25rem !important; }
        [dir="rtl"] .ms-2 { margin-left: 0 !important; margin-right: .5rem !important; }
        [dir="rtl"] .me-1 { margin-right: 0 !important; margin-left: .25rem !important; }
        [dir="rtl"] .me-2 { margin-right: 0 !important; margin-left: .5rem !important; }
    </style>
</head>
<body>
    <div class="container page-container">
        <div class="row justify-content-center">
            <div class="col-xl-10 col-lg-11">
                <div class="d-flex justify-content-end mb-3">
                    <div class="dropdown">
                        <button class="btn btn-outline-light dropdown-toggle d-flex align-items-center" type="button" id="langDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fa-solid fa-globe fa-lg me-2"></i>
                            <span id="currentLangLabel">EN</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="langDropdown">
                            <li><a class="dropdown-item lang-option" href="#" data-lang="en"><i class="fa-solid fa-language me-2"></i> English</a></li>
                            <li><a class="dropdown-item lang-option" href="#" data-lang="ar"><i class="fa-solid fa-language me-2"></i> العربية</a></li>
                        </ul>
                    </div>
                </div>
                <div class="card card-glass mb-3">
                    <div class="card-header-gradient">
                        <h1 class="h3 mb-0"><i class="fa-solid fa-circle-check me-2"></i> <span id="pageHeader">Test Scenarios Generated Successfully</span></h1>
                        <div class="small opacity-75 mt-1">AI-powered analysis complete</div>
                    </div>
                    <div class="card-body">
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            <span class="pill">Input: <span class="fw-semibold" th:text="${inputType}">Text</span></span>
                            <span class="pill" th:if="${fileName}">File: <span class="fw-semibold" th:text="${fileName}"></span></span>
                        </div>
                        <div class="section-title"><i class="fa-solid fa-circle-info me-2"></i><span id="labelInputPreview">Input Preview</span></div>
                        <div class="input-preview" th:text="${input}"></div>
                    </div>
                </div>

                <div class="card card-glass mb-3">
                    <div class="card-body position-relative">
                        <div class="section-title"><i class="fa-solid fa-list-check me-2"></i><span id="generatedTitle">Generated Test Scenarios</span></div>
                        <button id="btnCopyRaw" class="btn btn-sm btn-outline-secondary copy-btn" onclick="copyRaw()"><i class="fa-regular fa-copy me-1"></i><span data-i18n="copyRaw">Copy Raw</span></button>
                        <div id="rawText" th:text="${testConditions}" style="display:none;"></div>
                        <div id="generationTypeInitial" th:text="${generationType}" style="display:none;"></div>
                        <div id="initialStory" class="input-preview mb-3" style="display:none;"></div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="initialTable"></table>
                        </div>
                        <div class="mt-3 d-flex flex-wrap gap-2">
                            <button id="btnExportCSV" class="btn btn-success" onclick="exportInitialCSV()"><i class="fa-solid fa-file-csv me-1"></i><span data-i18n="exportCsv">Export CSV</span></button>
                            <button id="btnPrint" class="btn btn-outline-primary" onclick="printInitial()"><i class="fa-solid fa-print me-1"></i><span data-i18n="print">Print</span></button>
                            <a id="btnGenerateNew" href="/" class="btn btn-outline-secondary"><i class="fa-solid fa-plus me-1"></i><span data-i18n="generateNew">Generate New</span></a>
                        </div>
                    </div>
                </div>

                <div class="card card-glass mb-3">
                    <div class="card-body">
                        <div class="section-title"><i class="fa-solid fa-wand-magic-sparkles me-2"></i><span id="labelAddMore">Add More Results</span></div>
                        <div class="row g-3 align-items-end">
                            <div class="col-md-4">
                                <label class="form-label" id="labelWhatNeed">What do you need?</label>
                                <select id="generationType" class="form-select">
                                    <option value="user_story">User Story</option>
                                    <option value="test_cases" selected>Test Cases</option>
                                </select>
                            </div>
                            <div class="col-md-4" id="acceptanceWrap" style="display:none;">
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" id="includeAcceptance">
                                    <label class="form-check-label" id="labelIncludeAC" for="includeAcceptance">Include Acceptance Criteria</label>
                                </div>
                            </div>
                            <div class="col-12" id="typesWrap">
                                <label class="form-label" id="labelSelectTypes">Select desired types (optional):</label>
                                <div class="row row-cols-2 row-cols-md-3 g-2">
                                    <div class="col"><div class="form-check"><input class="form-check-input typeBox" type="checkbox" value="functional" id="typeFunctional"><label class="form-check-label" for="typeFunctional">Functional</label></div></div>
                                    <div class="col"><div class="form-check"><input class="form-check-input typeBox" type="checkbox" value="negative" id="typeNegative"><label class="form-check-label" for="typeNegative">Negative</label></div></div>
                                    <div class="col"><div class="form-check"><input class="form-check-input typeBox" type="checkbox" value="boundary" id="typeBoundary"><label class="form-check-label" for="typeBoundary">Boundary</label></div></div>
                                    <div class="col"><div class="form-check"><input class="form-check-input typeBox" type="checkbox" value="security" id="typeSecurity"><label class="form-check-label" for="typeSecurity">Security</label></div></div>
                                    <div class="col"><div class="form-check"><input class="form-check-input typeBox" type="checkbox" value="performance" id="typePerformance"><label class="form-check-label" for="typePerformance">Performance</label></div></div>
                                    <div class="col"><div class="form-check"><input class="form-check-input typeBox" type="checkbox" value="usability" id="typeUsability"><label class="form-check-label" for="typeUsability">Usability</label></div></div>
                                </div>
                            </div>
                            <div class="col-12 d-flex gap-2">
                                <button class="btn btn-primary" id="btnGenerateMore"><i class="fa-solid fa-plus me-1"></i><span data-i18n="generate">Generate</span></button>
                                <div id="genStatus" class="text-muted"></div>
                            </div>
                        </div>
                        <div id="originalInput" th:text="${input}" style="display:none;"></div>
                        <div id="originalInputType" th:text="${inputType}" style="display:none;"></div>
                    </div>
                </div>

                <div class="card card-glass mb-3">
                    <div class="card-body">
                        <div class="section-title"><i class="fa-solid fa-layer-group me-2"></i><span id="labelAllResults">All Results</span></div>
                        <ul class="nav nav-tabs" id="resultsTabs" role="tablist"></ul>
                        <div class="tab-content pt-3" id="resultsTabContent"></div>
                        <div class="mt-3 d-flex gap-2">
                            <button id="btnExportActiveCSV" class="btn btn-success btn-sm"><i class="fa-solid fa-file-csv me-1"></i>Export Active CSV</button>
                            <button id="btnExportActiveXLSX" class="btn btn-outline-success btn-sm"><i class="fa-solid fa-file-excel me-1"></i>Export Active Excel</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const I18N = {
            en: {
                pageHeader: 'Test Scenarios Generated Successfully',
                inputPreview: 'Input Preview',
                generatedUserStory: 'Generated User Story',
                generatedTestCases: 'Generated Test Cases',
                generatedTestScenarios: 'Generated Test Scenarios',
                copyRaw: 'Copy Raw',
                exportCsv: 'Export CSV',
                print: 'Print',
                generateNew: 'Generate New',
                addMore: 'Add More Results',
                whatNeed: 'What do you need?',
                includeAC: 'Include Acceptance Criteria',
                selectTypes: 'Select desired types (optional):',
                generate: 'Generate',
                allResults: 'All Results'
            },
            ar: {
                pageHeader: 'تم إنشاء سيناريوهات الاختبار بنجاح',
                inputPreview: 'معاينة الإدخال',
                generatedUserStory: 'قصة المستخدم المُولّدة',
                generatedTestCases: 'حالات الاختبار المُولّدة',
                generatedTestScenarios: 'سيناريوهات الاختبار المُولّدة',
                copyRaw: 'نسخ النص',
                exportCsv: 'تصدير CSV',
                print: 'طباعة',
                generateNew: 'توليد جديد',
                addMore: 'إضافة نتائج أخرى',
                whatNeed: 'ماذا تحتاج؟',
                includeAC: 'تضمين معايير القبول',
                selectTypes: 'اختر الأنواع المطلوبة (اختياري):',
                generate: 'توليد',
                allResults: 'كل النتائج'
            }
        };

        function applyLang(lang) {
            const t = I18N[lang] || I18N.en;
            const genType = (document.getElementById('generationTypeInitial').textContent || 'test_scenarios').toLowerCase();
            document.getElementById('pageHeader').textContent = t.pageHeader;
            document.getElementById('labelInputPreview').textContent = t.inputPreview;
            document.getElementById('generatedTitle').textContent = genType === 'user_story' ? t.generatedUserStory : (genType === 'test_cases' ? t.generatedTestCases : t.generatedTestScenarios);
            document.getElementById('btnCopyRaw').querySelector('[data-i18n="copyRaw"]').textContent = t.copyRaw;
            document.getElementById('btnExportCSV').querySelector('[data-i18n="exportCsv"]').textContent = t.exportCsv;
            document.getElementById('btnPrint').querySelector('[data-i18n="print"]').textContent = t.print;
            document.getElementById('btnGenerateNew').querySelector('[data-i18n="generateNew"]').textContent = t.generateNew;
            document.getElementById('labelAddMore').textContent = t.addMore;
            document.getElementById('labelWhatNeed').textContent = t.whatNeed;
            document.getElementById('labelIncludeAC').textContent = t.includeAC;
            document.getElementById('labelSelectTypes').textContent = t.selectTypes;
            document.getElementById('btnGenerateMore').querySelector('[data-i18n="generate"]').textContent = t.generate;
            document.getElementById('labelAllResults').textContent = t.allResults;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
        }
        // Parse markdown table
        function parseMarkdownTable(md) {
            if (!md) return null;
            md = md.replace(/```[a-zA-Z]*\n?|```/g, '');
            const lines = md.split('\n').map(l => l.trim());
            for (let i = 0; i < lines.length - 1; i++) {
                const headerLine = lines[i];
                const delimLine = lines[i + 1];
                if (!headerLine.startsWith('|') || !delimLine.startsWith('|')) continue;
                if (!/^\|?\s*:?[-\s|:]+:?\s*\|?$/.test(delimLine)) continue;
                const headers = headerLine.split('|').map(c => c.trim()).filter(c => c.length > 0);
                const rows = [];
                for (let j = i + 2; j < lines.length; j++) {
                    const rowLine = lines[j];
                    if (!rowLine || !rowLine.includes('|')) break;
                    if (!rowLine.startsWith('|')) break;
                    const cells = rowLine.split('|').map(c => c.trim());
                    const cleaned = cells.filter(c => c.length > 0);
                    if (cleaned.length === 0) continue;
                    rows.push(cleaned);
                }
                if (headers.length > 0 && rows.length > 0) {
                    return { headers, rows };
                }
            }
            return null;
        }

        function buildTableEl(parsed) {
            const table = document.createElement('table');
            table.className = 'table table-striped table-hover';
            table.style.tableLayout = 'fixed';
            table.style.width = '100%';
            
            const thead = document.createElement('thead');
            const thRow = document.createElement('tr');
            parsed.headers.forEach((h, index) => {
                const th = document.createElement('th'); 
                th.textContent = h;
                
                // Force column widths immediately
                const columnIndex = index + 1;
                if (columnIndex === 1) {
                    th.style.width = '15%';
                    th.style.minWidth = '100px';
                    th.style.maxWidth = '150px';
                } else if (columnIndex === 2) {
                    th.style.width = '25%';
                    th.style.minWidth = '150px';
                    th.style.maxWidth = '250px';
                } else if (columnIndex >= 3 && columnIndex <= 5) {
                    th.style.width = '20%';
                    th.style.minWidth = '120px';
                    th.style.maxWidth = '200px';
                } else {
                    th.style.width = 'auto';
                    th.style.minWidth = '100px';
                    th.style.maxWidth = '150px';
                }
                
                // Add specific styling for status columns
                if (h.toLowerCase().includes('status')) {
                    th.style.width = '15%';
                    th.style.minWidth = '100px';
                    th.style.maxWidth = '150px';
                }
                
                thRow.appendChild(th);
            });
            thead.appendChild(thRow);
            
            const tbody = document.createElement('tbody');
            parsed.rows.forEach(row => {
                const tr = document.createElement('tr');
                parsed.headers.forEach((header, idx) => {
                    const td = document.createElement('td');
                    const cellContent = row[idx] ?? '';
                    td.textContent = cellContent;
                    
                    // Force column widths immediately for data cells
                    const columnIndex = idx + 1;
                    if (columnIndex === 1) {
                        td.style.width = '15%';
                        td.style.minWidth = '100px';
                        td.style.maxWidth = '150px';
                    } else if (columnIndex === 2) {
                        td.style.width = '25%';
                        td.style.minWidth = '150px';
                        td.style.maxWidth = '250px';
                    } else if (columnIndex >= 3 && columnIndex <= 5) {
                        td.style.width = '20%';
                        td.style.minWidth = '120px';
                        td.style.maxWidth = '200px';
                    } else {
                        td.style.width = 'auto';
                        td.style.minWidth = '100px';
                        td.style.maxWidth = '150px';
                    }
                    
                    // Add specific styling for status columns
                    if (header.toLowerCase().includes('status')) {
                        td.style.width = '15%';
                        td.style.minWidth = '100px';
                        td.style.maxWidth = '150px';
                    }
                    
                    // Force text truncation
                    td.style.overflow = 'hidden';
                    td.style.textOverflow = 'ellipsis';
                    td.style.whiteSpace = 'nowrap';
                    
                    // Add tooltip for truncated content
                    if (cellContent.length > 50) {
                        td.title = cellContent;
                    }
                    
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(thead); table.appendChild(tbody);
            return table;
        }

        function tableToAOA(tableEl) {
            const aoa = [];
            const headCells = Array.from(tableEl.querySelectorAll('thead th')).map(th => th.textContent);
            if (headCells.length) aoa.push(headCells);
            Array.from(tableEl.querySelectorAll('tbody tr')).forEach(tr => {
                const row = Array.from(tr.children).map(td => td.textContent);
                aoa.push(row);
            });
            return aoa.length > 1 ? aoa : null;
        }

        function optimizeTableColumns(tableEl) {
            if (!tableEl) return;
            
            const headers = Array.from(tableEl.querySelectorAll('thead th'));
            const rows = Array.from(tableEl.querySelectorAll('tbody tr'));
            
            // Calculate optimal column widths based on content
            const columnWidths = headers.map((header, colIndex) => {
                const headerText = header.textContent;
                let maxLength = headerText.length;
                
                // Check all rows for this column
                rows.forEach(row => {
                    const cell = row.children[colIndex];
                    if (cell) {
                        const cellText = cell.textContent || '';
                        maxLength = Math.max(maxLength, cellText.length);
                    }
                });
                
                // Set reasonable limits
                const minWidth = 80;
                const maxWidth = 300;
                const calculatedWidth = Math.min(Math.max(maxLength * 8, minWidth), maxWidth);
                
                return {
                    width: calculatedWidth,
                    isStatus: headerText.toLowerCase().includes('status')
                };
            });
            
            // Apply optimized widths
            headers.forEach((header, index) => {
                const colWidth = columnWidths[index];
                if (colWidth.isStatus) {
                    header.style.width = '120px';
                    header.style.minWidth = '100px';
                    header.style.maxWidth = '150px';
                } else {
                    header.style.width = colWidth.width + 'px';
                    header.style.minWidth = '80px';
                }
            });
            
            // Apply same widths to data cells
            rows.forEach(row => {
                Array.from(row.children).forEach((cell, index) => {
                    const colWidth = columnWidths[index];
                    if (colWidth.isStatus) {
                        cell.style.width = '120px';
                        cell.style.minWidth = '100px';
                        cell.style.maxWidth = '150px';
                    } else {
                        cell.style.width = colWidth.width + 'px';
                        cell.style.minWidth = '80px';
                    }
                });
            });
        }

        function fixCanvasCharts() {
            // Fix all canvas elements that might be oversized
            const canvases = document.querySelectorAll('canvas');
            canvases.forEach(canvas => {
                // Reset canvas dimensions
                canvas.style.maxWidth = '100%';
                canvas.style.maxHeight = '350px';
                canvas.style.width = 'auto';
                canvas.style.height = 'auto';
                canvas.style.display = 'block';
                
                // Force canvas to have reasonable dimensions
                if (canvas.width > 800) {
                    canvas.width = 800;
                }
                if (canvas.height > 350) {
                    canvas.height = 350;
                }
            });
            
            // Fix specific chart containers
            const chartContainers = document.querySelectorAll('.chart-container, .compact-chart');
            chartContainers.forEach(container => {
                container.style.maxHeight = '350px';
                container.style.overflow = 'hidden';
                container.style.position = 'relative';
            });
            
            // Fix specific problematic charts
            const statusChart = document.getElementById('statusChart');
            const issueTypesChart = document.getElementById('issueTypesChart');
            const statusCanvas = document.getElementById('statusChartCanvas');
            const issueTypesCanvas = document.getElementById('issueTypesChartCanvas');
            
            if (statusChart) {
                statusChart.style.maxHeight = '350px';
                statusChart.style.overflow = 'hidden';
            }
            
            if (issueTypesChart) {
                issueTypesChart.style.maxHeight = '350px';
                issueTypesChart.style.overflow = 'hidden';
            }
            
            if (statusCanvas) {
                statusCanvas.style.maxHeight = '350px';
                statusCanvas.style.maxWidth = '100%';
                statusCanvas.style.width = 'auto';
                statusCanvas.style.height = 'auto';
                if (statusCanvas.height > 350) {
                    statusCanvas.height = 350;
                }
                if (statusCanvas.width > 800) {
                    statusCanvas.width = 800;
                }
            }
            
            if (issueTypesCanvas) {
                issueTypesCanvas.style.maxHeight = '350px';
                issueTypesCanvas.style.maxWidth = '100%';
                issueTypesCanvas.style.width = 'auto';
                issueTypesCanvas.style.height = 'auto';
                if (issueTypesCanvas.height > 350) {
                    issueTypesCanvas.height = 350;
                }
                if (issueTypesCanvas.width > 800) {
                    issueTypesCanvas.width = 800;
                }
            }
        }

        function renderInitial() {
            const md = document.getElementById('rawText').textContent;
            const genType = (document.getElementById('generationTypeInitial').textContent || 'test_scenarios').toLowerCase();
            const table = document.getElementById('initialTable');
            const storyDiv = document.getElementById('initialStory');
            if (genType === 'user_story') {
                // Extract story text before Acceptance Criteria blocks
                const lower = md.toLowerCase();
                const acIndex = lower.indexOf('acceptance criteria');
                const storyText = acIndex > -1 ? md.substring(0, acIndex).trim() : md.split('\n\n')[0] || md.split('\n')[0];
                if (storyText) { storyDiv.style.display = 'block'; storyDiv.textContent = storyText.trim(); }

                // Split into criteria blocks separated by blank lines
                const afterAC = acIndex > -1 ? md.substring(acIndex).split(/\n\n+/) : [];
                const blocks = afterAC
                    .map(b => b.replace(/^Acceptance Criteria:?\s*/i, '').trim())
                    .filter(b => b.length > 0);
                const headers = ['Acceptance Criteria'];
                const rows = blocks.length ? blocks.map(b => [b]) : [];
                const parsed = { headers, rows };
                if (rows.length) {
                    const tableEl = buildTableEl(parsed);
                    table.innerHTML = '';
                    table.appendChild(tableEl.querySelector('thead'));
                    table.appendChild(tableEl.querySelector('tbody'));
                    // Optimize column widths after table is built - multiple times to ensure it sticks
                    optimizeTableColumns(table);
                    setTimeout(() => optimizeTableColumns(table), 100);
                    setTimeout(() => optimizeTableColumns(table), 500);
                    window.__initialAOA = [headers, ...rows];
                } else {
                    table.innerHTML = '<tbody><tr><td class="text-muted">No acceptance criteria detected.</td></tr></tbody>';
                    window.__initialAOA = null;
                }
            } else {
                const parsed = parseMarkdownTable(md);
                if (parsed) {
                    const tableEl = buildTableEl(parsed);
                    table.innerHTML = '';
                    table.appendChild(tableEl.querySelector('thead'));
                    table.appendChild(tableEl.querySelector('tbody'));
                    // Optimize column widths after table is built - multiple times to ensure it sticks
                    optimizeTableColumns(table);
                    setTimeout(() => optimizeTableColumns(table), 100);
                    setTimeout(() => optimizeTableColumns(table), 500);
                    window.__initialAOA = [parsed.headers, ...parsed.rows];
                } else {
                    table.innerHTML = '<tbody><tr><td class="text-muted">No table detected in initial content.</td></tr></tbody>';
                    window.__initialAOA = null;
                }
            }
        }

        function copyRaw() {
            const text = document.getElementById('rawText').textContent;
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text);
            } else {
                const ta = document.createElement('textarea');
                ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
            }
        }

        function exportInitialCSV() {
            if (!window.__initialAOA) { alert('No table to export.'); return; }
            const ws = XLSX.utils.aoa_to_sheet(window.__initialAOA);
            const csv = XLSX.utils.sheet_to_csv(ws);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const genType = (document.getElementById('generationTypeInitial').textContent || 'test_scenarios').toLowerCase();
            const base = genType === 'user_story' ? 'user-story' : (genType === 'test_cases' ? 'test-cases' : 'test-scenarios');
            const a = document.createElement('a'); a.href = url; a.download = `${base}-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        }

        function printInitial() {
            const text = document.getElementById('rawText').textContent;
            const w = window.open('', '_blank');
            w.document.write('<!DOCTYPE html><html><head><title>Test Scenarios Report</title></head><body>');
            w.document.write('<h1>Test Scenarios Report</h1>');
            w.document.write('<pre style="white-space:pre-wrap;font-family:monospace;">' + text.replace(/</g,'&lt;') + '</pre>');
            w.document.write('</body></html>');
            w.document.close(); w.print();
        }

        function toggleOptionBlocks() {
            const type = document.getElementById('generationType').value;
            const acceptanceWrap = document.getElementById('acceptanceWrap');
            const typesWrap = document.getElementById('typesWrap');
            if (type === 'user_story') { acceptanceWrap.style.display = 'block'; typesWrap.style.display = 'none'; }
            else { acceptanceWrap.style.display = 'none'; typesWrap.style.display = 'block'; }
        }

        function getSelectedTypes() {
            return Array.from(document.querySelectorAll('.typeBox:checked')).map(cb => cb.value);
        }

        async function generateMore() {
            const genStatus = document.getElementById('genStatus');
            genStatus.textContent = 'Generating...';
            const payload = {
                input: document.getElementById('originalInput').textContent,
                inputType: document.getElementById('originalInputType').textContent || 'text',
                generationType: document.getElementById('generationType').value,
                includeAcceptance: document.getElementById('includeAcceptance').checked,
                selectedTypes: getSelectedTypes()
            };
            try {
                const res = await fetch('/api/generate-more', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const text = await res.text();
                appendResultCard(payload, text);
                genStatus.textContent = 'Done';
                setTimeout(() => genStatus.textContent = '', 1500);
            } catch (e) {
                genStatus.textContent = 'Error generating results';
            }
        }

        function appendResultCard(payload, content) {
            const tabs = document.getElementById('resultsTabs');
            const panes = document.getElementById('resultsTabContent');
            const id = `tab-${Date.now()}-${Math.random().toString(36).slice(2,7)}`;
            const label = payload.generationType === 'user_story' ? (payload.includeAcceptance ? 'User Story + AC' : 'User Story') : (payload.generationType === 'test_cases' ? 'Test Cases' : 'Test Scenarios');

            const tab = document.createElement('li'); tab.className = 'nav-item d-flex align-items-center'; tab.role = 'presentation';
            tab.innerHTML = `<button class="nav-link" id="${id}-tab" data-bs-toggle="tab" data-bs-target="#${id}" type="button" role="tab" aria-controls="${id}" aria-selected="false">${label}</button>
                             <button class="btn btn-sm btn-link text-danger ms-1" title="Close" data-close-tab="${id}"><i class="fa-solid fa-xmark"></i></button>`;
            tabs.appendChild(tab);

            const pane = document.createElement('div'); pane.className = 'tab-pane fade'; pane.id = id; pane.role = 'tabpanel'; pane.setAttribute('aria-labelledby', `${id}-tab`);

            const header = document.createElement('div'); header.className = 'd-flex align-items-center mb-2 result-card-title';
            const icon = document.createElement('i'); icon.className = payload.generationType === 'user_story' ? 'fa-solid fa-book-open me-2' : 'fa-solid fa-table me-2';
            const time = document.createElement('span'); time.className = 'badge bg-light text-dark result-badge ms-2'; time.textContent = new Date().toLocaleString();
            header.appendChild(icon); header.appendChild(document.createTextNode(label)); header.appendChild(time);
            pane.appendChild(header);

            const parsed = parseMarkdownTable(content);
            if (parsed) {
                const tbl = buildTableEl(parsed);
                tbl.setAttribute('data-table', 'true');
                pane.appendChild(tbl);
                // Optimize column widths for new tables immediately and after a delay
                optimizeTableColumns(tbl);
                setTimeout(() => optimizeTableColumns(tbl), 100);
                setTimeout(() => optimizeTableColumns(tbl), 500);
            } else {
                const pre = document.createElement('pre'); pre.style.whiteSpace = 'pre-wrap'; pre.textContent = content; pane.appendChild(pre);
            }

            const actions = document.createElement('div'); actions.className = 'mt-2 d-flex gap-2';
            const copyBtn = document.createElement('button'); copyBtn.className = 'btn btn-sm btn-outline-secondary'; copyBtn.innerHTML = '<i class="fa-regular fa-copy me-1"></i>Copy';
            copyBtn.onclick = () => { if (navigator.clipboard) navigator.clipboard.writeText(content); };
            actions.appendChild(copyBtn);
            pane.appendChild(actions);

            panes.appendChild(pane);

            // Activate the newly added tab
            const triggerEl = tab.querySelector('button');
            const tabObj = new bootstrap.Tab(triggerEl);
            tabObj.show();

            // Close handler
            tab.querySelector('[data-close-tab]').addEventListener('click', (e) => {
                e.stopPropagation();
                const targetId = e.currentTarget.getAttribute('data-close-tab');
                const paneEl = document.getElementById(targetId);
                const btnEl = document.getElementById(`${targetId}-tab`);
                if (paneEl) paneEl.remove();
                if (tab) tab.remove();
                // Activate last tab if any
                const lastBtn = document.querySelector('#resultsTabs .nav-link:last-of-type');
                if (lastBtn) { new bootstrap.Tab(lastBtn).show(); }
            });
        }

        // Export active tab content
        function exportActive(format) {
            const activePane = document.querySelector('#resultsTabContent .tab-pane.active');
            if (!activePane) { alert('No active tab'); return; }
            const tableEl = activePane.querySelector('[data-table="true"]');
            if (!tableEl) { alert('No table data in active tab'); return; }
            const aoa = tableToAOA(tableEl);
            if (!aoa) { alert('No table data in active tab'); return; }
            if (format === 'csv') {
                const ws = XLSX.utils.aoa_to_sheet(aoa);
                const csv = XLSX.utils.sheet_to_csv(ws);
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `tab-export-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            } else {
                const ws = XLSX.utils.aoa_to_sheet(aoa);
                const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
                XLSX.writeFile(wb, `tab-export-${new Date().toISOString().split('T')[0]}.xlsx`);
            }
        }

        function setLangUI(lang) {
            document.documentElement.lang = lang === 'ar' ? 'ar' : 'en';
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            document.getElementById('currentLangLabel').textContent = lang === 'ar' ? 'AR' : 'EN';
            if (typeof applyPerfLang === 'function') applyPerfLang(lang);
            if (typeof applyLanguage === 'function') applyLanguage(lang);
            if (typeof applyLang === 'function') applyLang(lang);
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Dynamic titles based on initial generation type
            const genType = (document.getElementById('generationTypeInitial').textContent || 'test_scenarios').toLowerCase();
            const pageHeader = document.getElementById('pageHeader');
            const generatedTitle = document.getElementById('generatedTitle');
            const label = genType === 'user_story' ? 'User Story Generated Successfully' : (genType === 'test_cases' ? 'Test Cases Generated Successfully' : 'Test Scenarios Generated Successfully');
            const genLabel = genType === 'user_story' ? 'Generated User Story' : (genType === 'test_cases' ? 'Generated Test Cases' : 'Generated Test Scenarios');
            pageHeader.textContent = label;
            generatedTitle.textContent = genLabel;

            renderInitial();
            toggleOptionBlocks();
            document.getElementById('generationType').addEventListener('change', toggleOptionBlocks);
            document.getElementById('btnGenerateMore').addEventListener('click', generateMore);
            // Seed tabs with initial result
            appendResultCard({ generationType: genType, includeAcceptance: false }, document.getElementById('rawText').textContent);
            
            // Force table column widths after page load
            setTimeout(() => {
                const tables = document.querySelectorAll('table');
                tables.forEach(table => {
                    if (table.querySelector('thead th')) {
                        optimizeTableColumns(table);
                    }
                });
            }, 500);
            
            // Fix Canvas charts sizing issues
            setTimeout(() => {
                fixCanvasCharts();
            }, 1000);

            // Language switching
            document.querySelectorAll('.lang-option').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const lang = this.getAttribute('data-lang');
                    localStorage.setItem('siteLang', lang);
                    setLangUI(lang);
                });
            });
            applyLang('en');

            // Export buttons
            document.getElementById('btnExportActiveCSV').addEventListener('click', () => exportActive('csv'));
            document.getElementById('btnExportActiveXLSX').addEventListener('click', () => exportActive('xlsx'));
            
            // Row selection + chat panel for test cases
            document.addEventListener('click', (e) => {
                const tr = e.target.closest('tr');
                if (!tr) return;
                const table = tr.closest('table');
                if (!table || !table.matches('[data-table="true"]')) return;
                table.querySelectorAll('tbody tr').forEach(r => r.classList.remove('row-selected'));
                tr.classList.add('row-selected');
                const rowText = Array.from(tr.children).map(td => td.textContent).join(' | ');
                showRowChat(rowText);
            });
        });

        function showRowChat(rowText) {
            let modal = document.getElementById('rowChatModal');
            if (!modal) {
                const wrapper = document.createElement('div');
                wrapper.innerHTML = `
<div class="modal fade" id="rowChatModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content" style="background:#0b1220;color:#e5e7eb;border:1px solid #334155;">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa-solid fa-comments me-2"></i>Ask about selected row</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2 small text-muted">Selected Row:</div>
        <div class="p-2 mb-3" style="background:#0f172a;border:1px solid #334155;border-radius:8px;white-space:pre-wrap;">${rowText.replace(/</g,'&lt;')}</div>
        <div class="mb-2">Your question</div>
        <textarea id="rowQuestion" class="form-control" rows="3" placeholder="Type your question..."></textarea>
        <div id="rowAnswer" class="mt-3" style="white-space:pre-wrap;"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="btnAskRow">Ask</button>
      </div>
    </div>
  </div>
</div>`;
                document.body.appendChild(wrapper.firstElementChild);
                modal = document.getElementById('rowChatModal');
            }
            const m = new bootstrap.Modal(modal);
            m.show();
            document.getElementById('rowAnswer').textContent = '';

            const askBtn = document.getElementById('btnAskRow');
            askBtn.onclick = async () => {
                const q = document.getElementById('rowQuestion').value.trim();
                if (!q) return;
                document.getElementById('rowAnswer').textContent = 'Thinking...';
                try {
                    const res = await fetch('/api/ask-row', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ rowText: rowText, question: q }) });
                    const text = await res.text();
                    document.getElementById('rowAnswer').textContent = text;
                } catch(e) {
                    document.getElementById('rowAnswer').textContent = 'Error getting answer';
                }
            };
        }
    </script>
</body>
</html>

