<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Scenarios</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet"/>
</head>
<body class="bg-light">
<div class="container py-4">
    <div class="d-flex justify-content-end mb-2">
        <div class="dropdown">
            <button class="btn btn-outline-primary dropdown-toggle d-flex align-items-center" type="button" id="langDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fa-solid fa-globe fa-lg me-2"></i>
                <span id="currentLangLabel">EN</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="langDropdown">
                <li><a class="dropdown-item lang-option" href="#" data-lang="en"><i class="fa-solid fa-language me-2"></i> English</a></li>
                <li><a class="dropdown-item lang-option" href="#" data-lang="ar"><i class="fa-solid fa-language me-2"></i> العربية</a></li>
            </ul>
        </div>
    </div>
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-plug"></i> <span id="hdrTitle">API Scenarios</span></h5>
            <div class="ms-2 small" id="hdrHint">Click a row to view Rest Assured code</div>
        </div>
        <div class="card-body">
            <ul class="nav nav-tabs" id="apiTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="scenarios-tab" data-bs-toggle="tab" data-bs-target="#scenarios" type="button" role="tab" aria-controls="scenarios" aria-selected="true">Scenarios</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="documentation-tab" data-bs-toggle="tab" data-bs-target="#documentation" type="button" role="tab" aria-controls="documentation" aria-selected="false">Documentation</button>
                </li>
            </ul>
            <div class="tab-content" id="apiTabsContent">
                <div class="tab-pane fade show active" id="scenarios" role="tabpanel" aria-labelledby="scenarios-tab">
            <div class="table-responsive">
                <table class="table table-striped align-middle">
                    <thead>
                    <tr>
                        <th>Title</th>
                        <th>Expected</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="sc : ${scenarios}" class="scenario-row" th:attr="data-id=${sc.id}">
                        <td th:text="${sc.title}"></td>
                        <td th:text="${sc.expectedStatus}">-</td>
                        <td class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-primary" th:attr="data-id=${sc.id}" onclick="runScenario(this)">
                                <i class="fas fa-play"></i> Run
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" th:attr="data-id=${sc.id}" onclick="viewCode(this)">
                                <i class="fas fa-code"></i> Code
                            </button>
                            <button class="btn btn-sm btn-outline-info" th:attr="data-id=${sc.id}" onclick="viewRequest(this)">
                                <i class="fas fa-file-alt"></i> Request
                            </button>
                                    <button class="btn btn-sm btn-outline-success" th:attr="data-id=${sc.id}" onclick="addToDocumentation(this)">
                                        <i class="fas fa-book"></i> Add to Documentation
                            </button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div class="row g-3 mt-1">
                <div class="col-md-7">
                    <div id="result" style="display:none;">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-terminal"></i> Response</span>
                                <div class="small" id="meta"></div>
                            </div>
                            <div class="card-body">
                                <div class="mb-2"><span class="badge text-bg-secondary" id="contentType">-</span> <span class="badge text-bg-info" id="statusBadge">-</span> <span class="badge text-bg-light text-dark" id="timeBadge">-</span></div>
                                <pre class="mb-2"><code id="resultText" class="language-json" style="max-height: 420px; overflow:auto; display:block;"></code></pre>
                                <details>
                                    <summary>Headers</summary>
                                    <pre class="mb-0"><code id="headersText" class="language-json" style="max-height: 200px; overflow:auto; display:block;"></code></pre>
                                </details>
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-outline-success" id="btnAssert">Add/Update Expected Assertion</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-5">
                    <div id="codePanel" style="display:none;">
                        <div class="card h-100">
                            <div class="card-header"><i class="fas fa-code"></i> Rest Assured</div>
                            <div class="card-body">
                                <pre class="language-java" style="max-height: 540px; overflow:auto;"><code id="codeText" class="language-java"></code></pre>
                            </div>
                        </div>
                    </div>
                    <div id="requestPanel" style="display:none;" class="mt-3">
                        <div class="card h-100">
                            <div class="card-header"><i class="fas fa-file-alt"></i> Request Details</div>
                            <div class="card-body">
                                <div class="mb-2"><span class="badge text-bg-dark" id="reqMethod">-</span> <code id="reqUrl">-</code></div>
                                <details open>
                                    <summary>Headers</summary>
                                    <pre class="mb-2"><code id="reqHeaders" class="language-json" style="max-height: 200px; overflow:auto; display:block;"></code></pre>
                                </details>
                                <details>
                                    <summary>Body</summary>
                                    <pre class="mb-0"><code id="reqBody" class="language-json" style="max-height: 260px; overflow:auto; display:block;"></code></pre>
                                </details>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="text-center mt-3">
                <a href="/" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> <span id="btnBack">Back</span></a>
                    </div>
                </div>
                <div class="tab-pane fade" id="documentation" role="tabpanel" aria-labelledby="documentation-tab">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <label for="docGroupSelect" class="form-label mb-0 me-2">Documentation Group:</label>
                            <select id="docGroupSelect" class="form-select d-inline-block w-auto"></select>
                            <button class="btn btn-sm btn-outline-success ms-2" id="btnAddGroup"><i class="fas fa-plus"></i></button>
                            <button class="btn btn-sm btn-outline-secondary ms-1" id="btnRenameGroup"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-outline-danger ms-1" id="btnDeleteGroup"><i class="fas fa-trash"></i></button>
                        </div>
                        <div>
                            <input type="text" id="docSearch" class="form-control form-control-sm d-inline-block w-auto" placeholder="Search...">
                            <span class="badge bg-info ms-2" id="docApiCount">0 APIs</span>
                        </div>
                    </div>
                    <div id="docTableWrap">
                        <div class="text-center text-muted">Select a group to view documentation.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Assertions Modal -->
<div class="modal fade" id="assertionsModal" tabindex="-1" aria-labelledby="assertionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assertionsModalLabel"><i class="fas fa-check-double"></i> Expected Assertions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Expected Status</label>
                        <input type="number" class="form-control" id="asExpectedStatus" min="100" max="599" placeholder="e.g. 200">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Status Family</label>
                        <select class="form-select" id="asStatusFamily">
                            <option value="">-- none --</option>
                            <option value="2xx">2xx (Success)</option>
                            <option value="3xx">3xx (Redirect)</option>
                            <option value="4xx">4xx (Client Error)</option>
                            <option value="5xx">5xx (Server Error)</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Content-Type</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="asContentType" placeholder="e.g. application/json">
                            <button class="btn btn-outline-secondary" type="button" id="btnFillCt">Use Current</button>
                        </div>
                    </div>
                </div>
                <hr/>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Response time less than (ms)</label>
                        <input type="number" class="form-control" id="asTimeLt" placeholder="e.g. 1000">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Body must contain (one per line)</label>
                        <textarea class="form-control" id="asContains" rows="2" placeholder="token\nsuccess\n...\n"></textarea>
                    </div>
                </div>
                <div class="row g-3 mt-1">
                    <div class="col-md-6">
                        <label class="form-label">Body must NOT contain (one per line)</label>
                        <textarea class="form-control" id="asNotContains" rows="2" placeholder="error\nstacktrace\n...\n"></textarea>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Header equals (name=value per line)</label>
                        <textarea class="form-control" id="asHeaderEquals" rows="2" placeholder="X-Request-Id=123\nServer=nginx\n..."></textarea>
                    </div>
                </div>
                <div class="row g-3 mt-1">
                    <div class="col-md-6">
                        <label class="form-label">Header exists (one header name per line)</label>
                        <textarea class="form-control" id="asHeaderExists" rows="2" placeholder="Content-Type\nX-Trace\n..."></textarea>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Header contains (name=substring per line)</label>
                        <textarea class="form-control" id="asHeaderContains" rows="2" placeholder="Server=nginx\nVia=cache\n..."></textarea>
                    </div>
                </div>
                <div class="row g-3 mt-1">
                    <div class="col-md-6">
                        <label class="form-label">JSONPath equals (path=value per line)</label>
                        <textarea class="form-control" id="asJsonPathEquals" rows="3" placeholder="data.id=123\nsuccess=true\n..."></textarea>
                        <div class="form-text">Booleans and numbers are auto-detected; use null for null.</div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">JSONPath size equals (path=size per line)</label>
                        <textarea class="form-control" id="asJsonPathSize" rows="3" placeholder="data.items=3\nerrors=0\n..."></textarea>
                    </div>
                </div>
                <div class="row g-3 mt-1">
                    <div class="col-md-6">
                        <label class="form-label">JSONPath contains item (path=value per line)</label>
                        <textarea class="form-control" id="asJsonPathContains" rows="3" placeholder="roles=admin\nids=123\n..."></textarea>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">JSONPath exists (one path per line)</label>
                        <textarea class="form-control" id="asJsonPathExists" rows="3" placeholder="data.items\nmeta.total\n..."></textarea>
                    </div>
                </div>
                <div class="row g-3 mt-1">
                    <div class="col-md-6">
                        <label class="form-label">XPath exists (one path per line)</label>
                        <textarea class="form-control" id="asXPathExists" rows="3" placeholder="/response/status\n/response/items/item\n..."></textarea>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">XPath equals (path=value per line)</label>
                        <textarea class="form-control" id="asXPathEquals" rows="3" placeholder="/response/status=OK\n/response/count=3\n..."></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="btnSaveAssertions"><i class="fas fa-save"></i> Save</button>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
<script th:inline="none">
    let currentScenarioId = null;
    let lastResponseMeta = null; // { httpStatus, contentType }
    async function runScenario(btn) {
        const id = btn.getAttribute('data-id');
        currentScenarioId = id;
        const res = await fetch('/api/run-scenario', { method: 'POST', headers: {'Content-Type': 'application/x-www-form-urlencoded'}, body: 'id=' + encodeURIComponent(id)});
        const json = await res.json();
        renderResponse(json);
    }

    function renderResponse(json) {
        const container = document.getElementById('result');
        const contentType = (json.contentType || '').toLowerCase();
        const statusBadge = document.getElementById('statusBadge');
        const ctBadge = document.getElementById('contentType');
        const timeBadge = document.getElementById('timeBadge');
        const headersPre = document.getElementById('headersText');

        // Pretty print JSON or XML; otherwise raw
        let bodyOut = json.body || '';
        if (contentType.includes('json')) {
            try { bodyOut = JSON.stringify(JSON.parse(bodyOut), null, 2); } catch {}
        } else if (contentType.includes('xml') || bodyOut.trim().startsWith('<')) {
            bodyOut = formatXml(bodyOut);
        }
        const isXml = bodyOut.trim().startsWith('<');
        const resultEl = document.getElementById('resultText');
        resultEl.className = isXml ? 'language-markup' : 'language-json';
        resultEl.textContent = bodyOut;
        Prism.highlightElement(resultEl);
        ctBadge.textContent = json.contentType || '-';
        statusBadge.textContent = 'HTTP ' + (json.httpStatus ?? '-');
        timeBadge.textContent = (json.timeMs != null ? json.timeMs + ' ms' : '');
        headersPre.textContent = JSON.stringify(json.headers || {}, null, 2);
        Prism.highlightElement(headersPre);
        container.style.display = 'block';
        resultEl.scrollIntoView({ behavior: 'smooth' });

        // Wire assertion button to current scenario id
        const btn = document.getElementById('btnAssert');
        if (btn) btn.onclick = () => openAssertModal();

        // save meta for quick-fill
        lastResponseMeta = { httpStatus: json.httpStatus, contentType: json.contentType };
    }

    async function viewCode(btnOrRow) {
        const id = btnOrRow.getAttribute('data-id');
        currentScenarioId = id;
        const res = await fetch('/api/scenario-code?id=' + encodeURIComponent(id));
        const json = await res.json();
        if (json.status === 'ok') {
            const codeEl = document.getElementById('codeText');
            codeEl.textContent = json.code;
            Prism.highlightElement(codeEl);
            document.getElementById('codePanel').style.display = 'block';
            codeEl.scrollIntoView({ behavior: 'smooth' });
        }
    }

    async function viewRequest(btnOrRow) {
        const id = btnOrRow.getAttribute('data-id');
        currentScenarioId = id;
        const res = await fetch('/api/scenario-detail?id=' + encodeURIComponent(id));
        const json = await res.json();
        if (json.status === 'ok') {
            document.getElementById('reqMethod').textContent = (json.method || 'GET');
            document.getElementById('reqUrl').textContent = json.url || '-';
            const reqHeaders = document.getElementById('reqHeaders');
            reqHeaders.textContent = JSON.stringify(json.headers || {}, null, 2);
            Prism.highlightElement(reqHeaders);
            let body = json.body || '';
            const looksJson = body.trim().startsWith('{') || body.trim().startsWith('[');
            if (looksJson) { try { body = JSON.stringify(JSON.parse(body), null, 2); } catch (e) {} }
            else if (body.trim().startsWith('<')) { body = formatXml(body); }
            const reqBody = document.getElementById('reqBody');
            reqBody.className = body.trim().startsWith('<') ? 'language-markup' : 'language-json';
            reqBody.textContent = body;
            Prism.highlightElement(reqBody);
            document.getElementById('requestPanel').style.display = 'block';
            document.getElementById('requestPanel').scrollIntoView({ behavior: 'smooth' });
        }
    }

    // Make entire row clickable to open request details
    document.querySelectorAll('.scenario-row').forEach(r => {
        r.addEventListener('click', (e) => {
            if (e.target.closest('button')) return; // ignore if a button was clicked
            currentScenarioId = r.getAttribute('data-id');
            viewRequest(r);
        });
    });

    function formatXml(xml) {
        try {
            let PADDING = '  '; // two spaces
            let reg = /(>)(<)(\/*)/g;
            xml = xml.replace(reg, '$1\n$2$3');
            let pad = 0; let formatted = '';
            xml.split('\n').forEach((node) => {
                if (!node) return;
                let indent = 0;
                if (node.match(/.+<\/\w[^>]*>$/)) {
                    indent = 0;
                } else if (node.match(/^<\/\w/)) {
                    if (pad !== 0) pad -= 1;
                } else if (node.match(/^<\w([^>]*[^\/])?>.*$/)) {
                    indent = 1;
                }
                formatted += PADDING.repeat(pad) + node + '\n';
                pad += indent;
            });
            return formatted.trim();
        } catch { return xml; }
    }

    // Assertion modal logic
    let assertionsModal;
    function openAssertModal() {
        if (!currentScenarioId) return;
        const modalEl = document.getElementById('assertionsModal');
        if (!assertionsModal) { assertionsModal = new bootstrap.Modal(modalEl); }
        // Reset form fields
        document.getElementById('asExpectedStatus').value = '';
        document.getElementById('asContentType').value = '';
        document.getElementById('asTimeLt').value = '';
        document.getElementById('asContains').value = '';
        document.getElementById('asNotContains').value = '';
        document.getElementById('asHeaderEquals').value = '';
        document.getElementById('asHeaderExists').value = '';
        document.getElementById('asHeaderContains').value = '';
        document.getElementById('asJsonPathEquals').value = '';
        document.getElementById('asJsonPathSize').value = '';
        document.getElementById('asJsonPathContains').value = '';
        document.getElementById('asJsonPathExists').value = '';
        document.getElementById('asXPathExists').value = '';
        document.getElementById('asXPathEquals').value = '';
        document.getElementById('asStatusFamily').value = '';
        // Prefill from scenario-detail if available
        prefillAssertions().finally(() => assertionsModal.show());
    }

    async function prefillAssertions() {
        try {
            const res = await fetch('/api/scenario-detail?id=' + encodeURIComponent(currentScenarioId));
            const json = await res.json();
            if (json.status !== 'ok') return;
            if (json.expectedStatus) document.getElementById('asExpectedStatus').value = json.expectedStatus;
            const as = json.assertions || {};
            if (as.contentType) document.getElementById('asContentType').value = as.contentType;
            if (as.timeLessThanMs) document.getElementById('asTimeLt').value = as.timeLessThanMs;
            if (Array.isArray(as.containsText)) document.getElementById('asContains').value = as.containsText.join('\n');
            if (Array.isArray(as.notContainsText)) document.getElementById('asNotContains').value = as.notContainsText.join('\n');
            if (Array.isArray(as.headerEquals)) {
                document.getElementById('asHeaderEquals').value = as.headerEquals.map(h => `${h.name}=${h.value}`).join('\n');
            }
            if (Array.isArray(as.headerExists)) {
                document.getElementById('asHeaderExists').value = as.headerExists.join('\n');
            }
            if (Array.isArray(as.headerContains)) {
                document.getElementById('asHeaderContains').value = as.headerContains.map(h => `${h.name}=${h.substring}`).join('\n');
            }
            if (Array.isArray(as.jsonPathEquals)) {
                document.getElementById('asJsonPathEquals').value = as.jsonPathEquals.map(j => `${j.path}=${j.value}`).join('\n');
            }
            if (Array.isArray(as.jsonPathSizeEquals)) {
                document.getElementById('asJsonPathSize').value = as.jsonPathSizeEquals.map(j => `${j.path}=${j.size}`).join('\n');
            }
            if (Array.isArray(as.jsonPathContains)) {
                document.getElementById('asJsonPathContains').value = as.jsonPathContains.map(j => `${j.path}=${j.value}`).join('\n');
            }
            if (Array.isArray(as.jsonPathExists)) {
                document.getElementById('asJsonPathExists').value = as.jsonPathExists.map(j => j.path).join('\n');
            }
            if (typeof as.expectedStatusRange === 'string') {
                document.getElementById('asStatusFamily').value = as.expectedStatusRange;
            }
            if (Array.isArray(as.xPathExists)) {
                document.getElementById('asXPathExists').value = as.xPathExists.map(x => x.path).join('\n');
            }
            if (Array.isArray(as.xPathEquals)) {
                document.getElementById('asXPathEquals').value = as.xPathEquals.map(x => `${x.path}=${x.value}`).join('\n');
            }
            // if empty and last response available, quick fill
            if (!document.getElementById('asExpectedStatus').value && lastResponseMeta && lastResponseMeta.httpStatus) {
                document.getElementById('asExpectedStatus').value = lastResponseMeta.httpStatus;
            }
            if (!document.getElementById('asContentType').value && lastResponseMeta && lastResponseMeta.contentType) {
                document.getElementById('asContentType').value = lastResponseMeta.contentType;
            }
        } catch (e) { /* ignore */ }
    }

    function parseKeyValueLines(text) {
        const out = [];
        (text || '').split('\n').map(l => l.trim()).filter(Boolean).forEach(line => {
            const idx = line.indexOf('=');
            if (idx > 0) {
                const name = line.substring(0, idx).trim();
                const valueRaw = line.substring(idx + 1).trim();
                out.push({ name, value: valueRaw });
            }
        });
        return out;
    }

    function parseNameSubstringLines(text) {
        const out = [];
        (text || '').split('\n').map(l => l.trim()).filter(Boolean).forEach(line => {
            const idx = line.indexOf('=');
            if (idx > 0) {
                const name = line.substring(0, idx).trim();
                const substring = line.substring(idx + 1).trim();
                out.push({ name, substring });
            }
        });
        return out;
    }

    function parseJsonPathEquals(text) {
        const out = [];
        (text || '').split('\n').map(l => l.trim()).filter(Boolean).forEach(line => {
            const idx = line.indexOf('=');
            if (idx > 0) {
                const path = line.substring(0, idx).trim();
                let valueStr = line.substring(idx + 1).trim();
                let value;
                if (valueStr === 'true' || valueStr === 'false') value = (valueStr === 'true');
                else if (valueStr === 'null') value = null;
                else if (!isNaN(Number(valueStr))) value = Number(valueStr);
                else value = valueStr;
                out.push({ path, value });
            }
        });
        return out;
    }

    function parseLines(text) {
        return (text || '').split('\n').map(l => l.trim()).filter(Boolean);
    }

    async function saveAssertions() {
        const payload = {
            id: currentScenarioId,
            expectedStatus: document.getElementById('asExpectedStatus').value ? Number(document.getElementById('asExpectedStatus').value) : undefined,
            assertions: {
                contentType: document.getElementById('asContentType').value || undefined,
                timeLessThanMs: document.getElementById('asTimeLt').value ? Number(document.getElementById('asTimeLt').value) : undefined,
                containsText: parseLines(document.getElementById('asContains').value),
                notContainsText: parseLines(document.getElementById('asNotContains').value),
                headerEquals: parseKeyValueLines(document.getElementById('asHeaderEquals').value),
                headerExists: parseLines(document.getElementById('asHeaderExists').value),
                headerContains: parseNameSubstringLines(document.getElementById('asHeaderContains').value),
                jsonPathEquals: parseJsonPathEquals(document.getElementById('asJsonPathEquals').value),
                jsonPathSizeEquals: (function(){ const arr = []; (document.getElementById('asJsonPathSize').value || '').split('\n').map(l=>l.trim()).filter(Boolean).forEach(line=>{ const i=line.indexOf('='); if(i>0){ const path=line.substring(0,i).trim(); const size=Number(line.substring(i+1).trim()); if(!isNaN(size)) arr.push({ path, size }); }}); return arr; })(),
                jsonPathContains: parseJsonPathEquals(document.getElementById('asJsonPathContains').value),
                jsonPathExists: parseLines(document.getElementById('asJsonPathExists').value).map(p => ({ path: p })),
                xPathExists: parseLines(document.getElementById('asXPathExists').value).map(p => ({ path: p })),
                xPathEquals: parseJsonPathEquals(document.getElementById('asXPathEquals').value),
                expectedStatusRange: document.getElementById('asStatusFamily').value || undefined
            }
        };
        const res = await fetch('/api/scenario-assertions', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        const json = await res.json();
        if (json.status === 'ok') {
            // refresh code panel to include assertions
            const codeRes = await fetch('/api/scenario-code?id=' + encodeURIComponent(currentScenarioId));
            const codeJson = await codeRes.json();
            if (codeJson.status === 'ok') {
                const codeEl = document.getElementById('codeText');
                codeEl.textContent = codeJson.code;
                Prism.highlightElement(codeEl);
                document.getElementById('codePanel').style.display = 'block';
                if (assertionsModal) assertionsModal.hide();
            }
        }
    }

    // Documentation Group Management
    let docGroups = [];
    let currentDocGroupId = null;
    async function loadDocGroups(selectId) {
        const res = await fetch('/api/documentation/groups');
        docGroups = await res.json();
        const sel = document.getElementById('docGroupSelect');
        sel.innerHTML = '';
        docGroups.forEach(g => {
            const opt = document.createElement('option');
            opt.value = g.id;
            opt.textContent = g.name;
            sel.appendChild(opt);
        });
        if (selectId) sel.value = selectId;
        else if (docGroups.length > 0) sel.value = docGroups[0].id;
        currentDocGroupId = sel.value;
        loadDocumentationTable();
    }
    document.getElementById('btnAddGroup').onclick = async () => {
        const name = prompt('Enter new group name:');
        if (!name) return;
        await fetch('/api/documentation/group/create', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: 'name=' + encodeURIComponent(name) });
        loadDocGroups();
    };
    document.getElementById('btnRenameGroup').onclick = async () => {
        const sel = document.getElementById('docGroupSelect');
        const id = sel.value;
        const group = docGroups.find(g => g.id === id);
        if (!group) return;
        const name = prompt('Enter new name:', group.name);
        if (!name || name === group.name) return;
        await fetch('/api/documentation/group/delete?id=' + encodeURIComponent(id), { method: 'POST' });
        await fetch('/api/documentation/group/create', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: 'name=' + encodeURIComponent(name) });
        loadDocGroups();
    };
    document.getElementById('btnDeleteGroup').onclick = async () => {
        const sel = document.getElementById('docGroupSelect');
        const id = sel.value;
        if (!id || !confirm('Delete this group and all its documentation?')) return;
        await fetch('/api/documentation/group/delete?id=' + encodeURIComponent(id), { method: 'POST' });
        loadDocGroups();
    };
    document.getElementById('docGroupSelect').onchange = function() {
        currentDocGroupId = this.value;
        loadDocumentationTable();
    };
    document.getElementById('docSearch').oninput = function() {
        loadDocumentationTable();
    };
    async function addToDocumentation(btn) {
        const id = btn.getAttribute('data-id');
        await loadDocGroups();
        let groupId = currentDocGroupId;
        if (!groupId) {
            alert('Please create a documentation group first.');
            return;
        }
        const title = prompt('Enter documentation title (optional):');
        const description = prompt('Enter documentation description (optional):');
        const res = await fetch('/api/documentation/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `id=${encodeURIComponent(id)}&title=${encodeURIComponent(title || '')}&description=${encodeURIComponent(description || '')}&groupId=${encodeURIComponent(groupId)}`
        });
        const json = await res.json();
        if (json.status === 'ok') {
            alert('Added to documentation!');
            if (document.getElementById('documentation-tab').classList.contains('active')) {
                loadDocumentationTable();
            }
        } else {
            alert('Failed to add: ' + (json.message || 'Unknown error'));
        }
    }
    async function loadDocumentationTable() {
        const groupId = currentDocGroupId;
        const docTableWrap = document.getElementById('docTableWrap');
        if (!groupId) {
            docTableWrap.innerHTML = '<div class="text-center text-muted">Select a group to view documentation.</div>';
            document.getElementById('docApiCount').textContent = '0 APIs';
            return;
        }
        const res = await fetch('/api/documentation/grouped?groupId=' + encodeURIComponent(groupId));
        const json = await res.json();
        let allDocs = [];
        for (const [endpoint, methods] of Object.entries(json)) {
            for (const [method, docs] of Object.entries(methods)) {
                docs.forEach(doc => {
                    allDocs.push({ ...doc, endpoint, method });
                });
            }
        }
        // Filter
        const search = document.getElementById('docSearch').value.toLowerCase();
        if (search) {
            allDocs = allDocs.filter(doc => (doc.title || '').toLowerCase().includes(search) || (doc.endpoint || '').toLowerCase().includes(search) || (doc.method || '').toLowerCase().includes(search));
        }
        document.getElementById('docApiCount').textContent = allDocs.length + ' APIs';
        if (allDocs.length === 0) {
            docTableWrap.innerHTML = '<div class="text-center text-muted">No documentation found for this group.</div>';
            return;
        }
        let html = `<div class="table-responsive"><table class="table table-striped align-middle" id="docTable"><thead><tr>
            <th style="width: 30%;">API Details</th>
            <th>Endpoint</th>
            <th>Method</th>
            <th>Expected</th>
            <th>Assertions</th>
            <th>cURL</th>
            <th>Tags</th>
            <th>Status</th>
            <th>Last Tested</th>
            <th>Notes</th>
            <th>Actions</th>
        </tr></thead><tbody>`;
        allDocs.forEach(doc => {
            const scenarioId = doc.metadata && doc.metadata.scenarioId ? doc.metadata.scenarioId : doc.id;
            // Parse fields from metadata
            const body = doc.metadata && doc.metadata.body ? doc.metadata.body : '';
            const headers = doc.metadata && doc.metadata.headers ? doc.metadata.headers : '';
            const expected = doc.metadata && doc.metadata.expectedStatus ? doc.metadata.expectedStatus : '';
            const assertions = doc.metadata && doc.metadata.assertions ? doc.metadata.assertions : '';
            const curl = doc.metadata && doc.metadata.curl ? doc.metadata.curl : '';
            const notes = doc.metadata && doc.metadata.notes ? doc.metadata.notes : '';
            const tags = doc.metadata && doc.metadata.tags ? doc.metadata.tags : '';
            const status = doc.metadata && doc.metadata.status ? doc.metadata.status : 'Draft';
            const lastTested = doc.metadata && doc.metadata.lastTested ? doc.metadata.lastTested : '';
            html += `<tr data-docid="${doc.id}" data-scenarioid="${scenarioId}">
                <td>
                    <div class="api-details">
                        <div class="mb-2">
                            <input class="form-control form-control-sm doc-title-input" value="${doc.title || ''}" data-id="${doc.id}" placeholder="API Title"/>
                        </div>
                        <div class="mb-2">
                            <textarea class="form-control form-control-sm doc-desc-input" data-id="${doc.id}" placeholder="API Description" rows="2">${doc.description || ''}</textarea>
                        </div>
                    </div>
                </td>
                <td><code>${doc.endpoint || ''}</code></td>
                <td><span class="badge bg-primary">${doc.method || ''}</span></td>
                <td>${expected}</td>
                <td><pre style='max-width:200px;max-height:80px;overflow:auto;font-size:12px;'>${assertions}</pre></td>
                <td><pre style='max-width:200px;max-height:80px;overflow:auto;font-size:12px;'>${curl}</pre></td>
                <td><input class="form-control form-control-sm doc-tags-input" value="${tags}" data-id="${doc.id}" placeholder="tag1, tag2"/></td>
                <td><select class="form-select form-select-sm doc-status-input" data-id="${doc.id}">
                    <option${status==='Draft'?' selected':''}>Draft</option>
                    <option${status==='Reviewed'?' selected':''}>Reviewed</option>
                    <option${status==='Approved'?' selected':''}>Approved</option>
                    <option${status==='Deprecated'?' selected':''}>Deprecated</option>
                </select></td>
                <td><span class="doc-last-tested" data-id="${doc.id}">${lastTested}</span></td>
                <td><input class="form-control form-control-sm doc-notes-input" value="${notes}" data-id="${doc.id}"/></td>
                <td class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary doc-run" data-id="${scenarioId}" title="Run"><i class="fas fa-play"></i></button>
                    <button class="btn btn-sm btn-outline-secondary doc-code" data-id="${scenarioId}" title="Code"><i class="fas fa-code"></i></button>
                    <button class="btn btn-sm btn-outline-danger doc-delete" data-id="${doc.id}" title="Delete"><i class="fas fa-trash"></i></button>
                    <button class="btn btn-sm btn-outline-dark doc-move" data-id="${doc.id}" title="Move"><i class="fas fa-exchange-alt"></i></button>
                </td>
            </tr>`;
        });
        html += '</tbody></table></div>';
        docTableWrap.innerHTML = html;
        console.log('[DEBUG] Documentation table rendered, calling bindDocTableActions');
        bindDocTableActions();
        // Auto-expand request details for all docs in the current group
        autoExpandRequests();
        // إضافة حفظ تلقائي للحقول القابلة للتعديل
        setTimeout(() => {
            document.querySelectorAll('.doc-title-input').forEach(input => {
                input.addEventListener('change', function() {
                    const id = this.getAttribute('data-id');
                    fetch('/api/documentation/edit', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `id=${encodeURIComponent(id)}&title=${encodeURIComponent(this.value)}`
                    });
                });
            });
            document.querySelectorAll('.doc-desc-input').forEach(input => {
                input.addEventListener('change', function() {
                    const id = this.getAttribute('data-id');
                    fetch('/api/documentation/edit', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `id=${encodeURIComponent(id)}&description=${encodeURIComponent(this.value)}`
                    });
                });
            });
            document.querySelectorAll('.doc-notes-input').forEach(input => {
                input.addEventListener('change', function() {
                    const id = this.getAttribute('data-id');
                    fetch('/api/documentation/edit', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `id=${encodeURIComponent(id)}&notes=${encodeURIComponent(this.value)}`
                    });
                });
            });
            document.querySelectorAll('.doc-tags-input').forEach(input => {
                input.addEventListener('change', function() {
                    const id = this.getAttribute('data-id');
                    fetch('/api/documentation/edit', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `id=${encodeURIComponent(id)}&tags=${encodeURIComponent(this.value)}`
                    });
                });
            });
            document.querySelectorAll('.doc-status-input').forEach(select => {
                select.addEventListener('change', function() {
                    const id = this.getAttribute('data-id');
                    fetch('/api/documentation/edit', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `id=${encodeURIComponent(id)}&status=${encodeURIComponent(this.value)}`
                    });
                });
            });
        }, 200);
    }

    function bindDocTableActions() {
        const table = document.getElementById('docTable');
        if (!table) { console.log('[DEBUG] docTable not found'); return; }
        // Remove any previous result rows
        table.querySelectorAll('.doc-result-row').forEach(r => r.remove());
        // Run
        const runBtns = table.querySelectorAll('.doc-run');
        console.log('[DEBUG] Found', runBtns.length, 'run buttons');
        runBtns.forEach(btn => {
            btn.addEventListener('click', async function() {
                const scenarioId = btn.getAttribute('data-id');
                // احصل على doc.id من الصف الأب
                const row = btn.closest('tr[data-docid]');
                const docId = row ? row.getAttribute('data-docid') : scenarioId;
                currentScenarioId = scenarioId;
                try {
                    const res = await fetch('/api/run-scenario', { method: 'POST', headers: {'Content-Type': 'application/x-www-form-urlencoded'}, body: 'id=' + encodeURIComponent(scenarioId)});
                    const json = await res.json();
                    // تحديث lastTested في الواجهة
                    const now = new Date().toLocaleString();
                    const lastTestedSpan = row.querySelector('.doc-last-tested');
                    if (lastTestedSpan) lastTestedSpan.textContent = now;
                    // حفظ lastTested في backend
                    fetch('/api/documentation/edit', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `id=${encodeURIComponent(docId)}&lastTested=${encodeURIComponent(now)}`
                    });
                    console.log('[DOC RUN] Response:', json); // log response
                    // Find existing request row and append response to it
                    const existingRequestRow = table.querySelector(`tr[data-docid='${docId}'] + .doc-result-row`);
                    if (existingRequestRow) {
                        // Append response to existing request row
                        const responseHtml = renderDocResponse(json);
                        existingRequestRow.querySelector('td').innerHTML += responseHtml;
                    } else {
                        // Create new row if no request row exists
                        insertDocResultRow(docId, renderDocResponse(json));
                    }
                } catch (error) {
                    insertDocResultRow(docId, '<div class="text-danger">Error: ' + error.message + '</div>');
                }
            });
        });
        // Code
        const codeBtns = table.querySelectorAll('.doc-code');
        console.log('[DEBUG] Found', codeBtns.length, 'code buttons');
        codeBtns.forEach(btn => {
            btn.addEventListener('click', async function() {
                const scenarioId = btn.getAttribute('data-id');
                const row = btn.closest('tr[data-docid]');
                const docId = row ? row.getAttribute('data-docid') : scenarioId;
                currentScenarioId = scenarioId;
                try {
                    const res = await fetch('/api/scenario-code?id=' + encodeURIComponent(scenarioId));
                    const json = await res.json();
                    console.log('[DOC CODE] Response:', json); // log response
                    insertDocResultRow(docId, renderDocCode(json));
                } catch (error) {
                    insertDocResultRow(docId, '<div class="text-danger">Error: ' + error.message + '</div>');
                }
            });
        });
        // Request
        const reqBtns = table.querySelectorAll('.doc-request');
        console.log('[DEBUG] Found', reqBtns.length, 'request buttons');
        reqBtns.forEach(btn => {
            btn.addEventListener('click', async function() {
                const scenarioId = btn.getAttribute('data-id');
                const row = btn.closest('tr[data-docid]');
                const docId = row ? row.getAttribute('data-docid') : scenarioId;
                currentScenarioId = scenarioId;
                try {
                    const res = await fetch('/api/scenario-detail?id=' + encodeURIComponent(scenarioId));
                    const json = await res.json();
                    console.log('[DOC REQUEST] Response:', json); // log response
                    insertDocResultRow(docId, renderDocRequest(json));
                } catch (error) {
                    insertDocResultRow(docId, '<div class="text-danger">Error: ' + error.message + '</div>');
                }
            });
        });
        // Edit
        const editBtns = table.querySelectorAll('.doc-edit');
        console.log('[DEBUG] Found', editBtns.length, 'edit buttons');
        editBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const id = btn.getAttribute('data-id');
                const row = table.querySelector(`tr[data-docid='${id}']`);
                const title = row ? row.children[0].textContent : '';
                const newTitle = prompt('Edit title:', title);
                if (newTitle === null) return;
                const newDescription = prompt('Edit description (optional):', '');
                fetch('/api/documentation/edit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `id=${encodeURIComponent(id)}&title=${encodeURIComponent(newTitle)}&description=${encodeURIComponent(newDescription || '')}`
                }).then(r => r.json()).then(json => {
                    if (json.status === 'ok') loadDocumentationTable();
                    else alert('Failed to edit.');
                });
            });
        });
        // Delete
        const delBtns = table.querySelectorAll('.doc-delete');
        console.log('[DEBUG] Found', delBtns.length, 'delete buttons');
        delBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const id = btn.getAttribute('data-id');
                if (!confirm('Delete this documentation entry?')) return;
                fetch('/api/documentation/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `id=${encodeURIComponent(id)}`
                }).then(r => r.json()).then(json => {
                    if (json.status === 'ok') loadDocumentationTable();
                    else alert('Failed to delete.');
                });
            });
        });
        // Move
        const moveBtns = table.querySelectorAll('.doc-move');
        console.log('[DEBUG] Found', moveBtns.length, 'move buttons');
        moveBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const id = btn.getAttribute('data-id');
                if (!docGroups.length) return;
                const groupNames = docGroups.map(g => g.name).join('\n');
                const groupId = prompt('Enter the name of the group to move to:\n' + groupNames);
                const group = docGroups.find(g => g.name === groupId);
                if (!group) { alert('Group not found.'); return; }
                fetch('/api/documentation/move', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `id=${encodeURIComponent(id)}&groupId=${encodeURIComponent(group.id)}`
                }).then(r => r.json()).then(json => {
                    if (json.status === 'ok') loadDocumentationTable();
                    else alert('Failed to move.');
                });
            });
        });
        console.log('[DEBUG] bindDocTableActions finished');
    }

    function insertDocResultRow(docId, html) {
        console.log('[insertDocResultRow] docId:', docId, 'html:', html); // تتبع التنفيذ
        const table = document.getElementById('docTable');
        // Remove any previous result row for this doc
        table.querySelectorAll(`tr[data-docid='${docId}'] + .doc-result-row`).forEach(r => r.remove());
        // Insert new row after the doc row
        const docRow = table.querySelector(`tr[data-docid='${docId}']`);
        if (!docRow) return;
        const resultRow = document.createElement('tr');
        resultRow.className = 'doc-result-row';
        const colCount = table && table.querySelector('thead tr') ? table.querySelector('thead tr').children.length : 1;
        resultRow.innerHTML = `<td colspan="${colCount}">${html}<div class='text-end'><button class='btn btn-sm btn-outline-secondary mt-2 close-doc-result'>Close</button></div></td>`;
        docRow.parentNode.insertBefore(resultRow, docRow.nextSibling);
        resultRow.querySelector('.close-doc-result').onclick = () => resultRow.remove();
        
        // Apply syntax highlighting to code blocks
        setTimeout(() => {
            resultRow.querySelectorAll('pre code').forEach(code => {
                if (code.className.includes('language-')) {
                    Prism.highlightElement(code);
                }
            });
        }, 100);
    }
    async function autoExpandRequests() {
        const rows = document.querySelectorAll('#docTable tr[data-docid]');
        for (const row of rows) {
            const docId = row.getAttribute('data-docid');
            const scenarioId = row.getAttribute('data-scenarioid');
            if (!scenarioId) continue;
            try {
                const res = await fetch('/api/scenario-detail?id=' + encodeURIComponent(scenarioId));
                const json = await res.json();
                insertDocResultRow(docId, renderDocRequest(json));
            } catch (e) {
                // ignore per-row errors
            }
        }
    }
    function renderDocResponse(json) {
        const contentType = (json.contentType || '').toLowerCase();
        let bodyOut = json.body || '';
        if (contentType.includes('json')) {
            try { bodyOut = JSON.stringify(JSON.parse(bodyOut), null, 2); } catch {}
        } else if (contentType.includes('xml') || bodyOut.trim().startsWith('<')) {
            bodyOut = formatXml(bodyOut);
        }
        const isXml = bodyOut.trim().startsWith('<');
        return `<div class="mt-3"><b>Response:</b> <span class='badge bg-info'>${json.contentType || '-'}</span> <span class='badge bg-secondary'>HTTP ${json.httpStatus ?? '-'}</span> <span class='badge bg-light text-dark'>${json.timeMs != null ? json.timeMs + ' ms' : ''}</span></div><pre class='${isXml ? 'language-markup' : 'language-json'}' style='max-height:320px;overflow:auto;'>${bodyOut}</pre>`;
    }
    function renderDocCode(json) {
        if (json.status !== 'ok') return '<div class="text-danger">Failed to load code.</div>';
        return `<div><b>Rest Assured Code:</b></div><pre class='language-java' style='max-height:320px;overflow:auto;'>${json.code}</pre>`;
    }
    function renderDocRequest(json) {
        if (json.status !== 'ok') return '<div class="text-danger">Failed to load request details.</div>';
        let body = json.body || '';
        const looksJson = body.trim().startsWith('{') || body.trim().startsWith('[');
        if (looksJson) { try { body = JSON.stringify(JSON.parse(body), null, 2); } catch (e) {} }
        else if (body.trim().startsWith('<')) { body = formatXml(body); }
        return `<div><b>Request:</b> <span class='badge bg-dark'>${json.method || 'GET'}</span> <code>${json.url || '-'}</code></div><details open><summary>Headers</summary><pre class='language-json' style='max-height:120px;overflow:auto;'>${JSON.stringify(json.headers || {}, null, 2)}</pre></details><details><summary>Body</summary><pre class='${body.trim().startsWith('<') ? 'language-markup' : 'language-json'}' style='max-height:180px;overflow:auto;'>${body}</pre></details>`;
    }
    // Initial load
    document.getElementById('documentation-tab').addEventListener('shown.bs.tab', () => loadDocGroups());
</script>
<script>
    const I18N_API = {
        en: { hdrTitle: 'API Scenarios', hdrHint: 'Click a row to view Rest Assured code', title: 'Title', expected: 'Expected', actions: 'Actions', run: 'Run', code: 'Code', request: 'Request', response: 'Response', headers: 'Headers', requestDetails: 'Request Details', back: 'Back' },
        ar: { hdrTitle: 'سيناريوهات API', hdrHint: 'اضغط على صف لعرض كود Rest Assured', title: 'العنوان', expected: 'المتوقع', actions: 'الإجراءات', run: 'تشغيل', code: 'الكود', request: 'الطلب', response: 'الاستجابة', headers: 'الرؤوس', requestDetails: 'تفاصيل الطلب', back: 'رجوع' }
    };
    function applyApiLang(lang) {
        const t = I18N_API[lang] || I18N_API.en;
        document.getElementById('hdrTitle').textContent = t.hdrTitle;
        document.getElementById('hdrHint').textContent = t.hdrHint;
        const ths = document.querySelectorAll('thead th');
        if (ths[0]) ths[0].textContent = t.title; if (ths[1]) ths[1].textContent = t.expected; if (ths[2]) ths[2].textContent = t.actions;
        document.querySelectorAll('button[onclick^="runScenario"]').forEach(b => { const i=b.querySelector('i'); b.innerHTML = ''; b.appendChild(i); b.append(' ' + t.run); });
        document.querySelectorAll('button[onclick^="viewCode"]').forEach(b => { const i=b.querySelector('i'); b.innerHTML = ''; b.appendChild(i); b.append(' ' + t.code); });
        document.querySelectorAll('button[onclick^="viewRequest"]').forEach(b => { const i=b.querySelector('i'); b.innerHTML = ''; b.appendChild(i); b.append(' ' + t.request); });
        const back = document.getElementById('btnBack'); if (back) back.textContent = t.back;
        document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
    }
    function setLangUI(lang) {
        document.documentElement.lang = lang === 'ar' ? 'ar' : 'en';
        document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
        const lbl = document.getElementById('currentLangLabel'); if (lbl) lbl.textContent = lang === 'ar' ? 'AR' : 'EN';
        if (typeof applyApiLang === 'function') applyApiLang(lang);
        if (typeof applyPerfLang === 'function') applyPerfLang(lang);
        if (typeof applyLanguage === 'function') applyLanguage(lang);
        if (typeof applyLang === 'function') applyLang(lang);
    }
    document.addEventListener('DOMContentLoaded', function() {
        const saved = localStorage.getItem('siteLang') || 'en';
        setLangUI(saved);
        document.querySelectorAll('.lang-option').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const lang = this.getAttribute('data-lang');
                localStorage.setItem('siteLang', lang);
                setLangUI(lang);
            });
        });
    });
</script>
<style>
.doc-result-row { display: table-row !important; background: #f9f9f9; }
.api-details { min-width: 250px; }
.doc-title-input { font-weight: 600; }
.doc-desc-input { resize: vertical; min-height: 60px; }
</style>
</body>
</html>