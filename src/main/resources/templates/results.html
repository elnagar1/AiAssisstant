<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Scenarios Generated - Test Analyst AI Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0b1220 0%, #020617 100%);
            min-height: 100vh;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            color: #e5e7eb;
        }
        .page-container { padding: 24px 12px; }
        .card-glass {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,.4);
            color: #e5e7eb;
        }
        .card-header-gradient {
            background: linear-gradient(45deg, #22c55e, #3b82f6);
            color: #fff;
            border-radius: 16px 16px 0 0 !important;
            padding: 20px;
            text-align: center;
        }
        .section-title { border-bottom: 1px solid #334155; padding-bottom: 10px; margin-bottom: 16px; color: #e2e8f0; }
        .input-preview { background: #0b1220; border-left: 4px solid #3b82f6; border-radius: 12px; padding: 16px; white-space: pre-wrap; color: #e5e7eb; }
        .copy-btn { position: absolute; top: 10px; right: 10px; }
        .result-badge { font-size: .8rem; }
        .result-card-title { display: flex; align-items: center; gap: 8px; }
        .table { color: #e5e7eb; }
        .table thead th { background: #0f172a; color: #cbd5e1; border-color: #334155; }
        .table tbody td { border-color: #334155; }
        .pill { display: inline-block; padding: 4px 10px; border-radius: 999px; font-size: .8rem; color: #e5e7eb; background: rgba(51,65,85,.6); margin-right: 6px; }
        .form-select, .form-control { background-color: #0f172a; color: #e5e7eb; border-color: #334155; }
        .form-select:focus, .form-control:focus { background-color: #0f172a; color: #e5e7eb; border-color: #3b82f6; box-shadow: 0 0 0 .2rem rgba(59,130,246,.25); }
        .btn-outline-secondary { color: #e5e7eb; border-color: #475569; }
        .btn-outline-secondary:hover { background: #1f2937; color: #fff; }
        .btn-outline-primary { color: #93c5fd; border-color: #60a5fa; }
        .btn-outline-primary:hover { background: #1d4ed8; color: #fff; }
        .btn-success { background: #16a34a; border-color: #16a34a; }
        .btn-primary { background: #2563eb; border-color: #2563eb; }
    </style>
</head>
<body>
    <div class="container page-container">
        <div class="row justify-content-center">
            <div class="col-xl-10 col-lg-11">
                <div class="card card-glass mb-3">
                    <div class="card-header-gradient">
                        <h1 class="h3 mb-0"><i class="fa-solid fa-circle-check me-2"></i> <span id="pageHeader">Test Scenarios Generated Successfully</span></h1>
                        <div class="small opacity-75 mt-1">AI-powered analysis complete</div>
                    </div>
                    <div class="card-body">
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            <span class="pill">Input: <span class="fw-semibold" th:text="${inputType}">Text</span></span>
                            <span class="pill" th:if="${fileName}">File: <span class="fw-semibold" th:text="${fileName}"></span></span>
                        </div>
                        <div class="section-title"><i class="fa-solid fa-circle-info me-2"></i>Input Preview</div>
                        <div class="input-preview" th:text="${input}"></div>
                    </div>
                </div>

                <div class="card card-glass mb-3">
                    <div class="card-body position-relative">
                        <div class="section-title"><i class="fa-solid fa-list-check me-2"></i><span id="generatedTitle">Generated Test Scenarios</span></div>
                        <button class="btn btn-sm btn-outline-secondary copy-btn" onclick="copyRaw()"><i class="fa-regular fa-copy me-1"></i>Copy Raw</button>
                        <div id="rawText" th:text="${testConditions}" style="display:none;"></div>
                        <div id="generationTypeInitial" th:text="${generationType}" style="display:none;"></div>
                        <div id="initialStory" class="input-preview mb-3" style="display:none;"></div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="initialTable"></table>
                        </div>
                        <div class="mt-3 d-flex flex-wrap gap-2">
                            <button class="btn btn-success" onclick="exportInitialCSV()"><i class="fa-solid fa-file-csv me-1"></i>Export CSV</button>
                            <button class="btn btn-outline-primary" onclick="printInitial()"><i class="fa-solid fa-print me-1"></i>Print</button>
                            <a href="/" class="btn btn-outline-secondary"><i class="fa-solid fa-plus me-1"></i>Generate New</a>
                        </div>
                    </div>
                </div>

                <div class="card card-glass mb-3">
                    <div class="card-body">
                        <div class="section-title"><i class="fa-solid fa-wand-magic-sparkles me-2"></i>Add More Results</div>
                        <div class="row g-3 align-items-end">
                            <div class="col-md-4">
                                <label class="form-label">What do you need?</label>
                                <select id="generationType" class="form-select">
                                    <option value="user_story">User Story</option>
                                    <option value="test_cases">Test Cases</option>
                                    <option value="test_scenarios" selected>Test Scenarios</option>
                                </select>
                            </div>
                            <div class="col-md-4" id="acceptanceWrap" style="display:none;">
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" id="includeAcceptance">
                                    <label class="form-check-label" for="includeAcceptance">Include Acceptance Criteria</label>
                                </div>
                            </div>
                            <div class="col-12" id="typesWrap">
                                <label class="form-label">Select desired types (optional):</label>
                                <div class="row row-cols-2 row-cols-md-3 g-2">
                                    <div class="col"><div class="form-check"><input class="form-check-input typeBox" type="checkbox" value="functional" id="typeFunctional"><label class="form-check-label" for="typeFunctional">Functional</label></div></div>
                                    <div class="col"><div class="form-check"><input class="form-check-input typeBox" type="checkbox" value="negative" id="typeNegative"><label class="form-check-label" for="typeNegative">Negative</label></div></div>
                                    <div class="col"><div class="form-check"><input class="form-check-input typeBox" type="checkbox" value="boundary" id="typeBoundary"><label class="form-check-label" for="typeBoundary">Boundary</label></div></div>
                                    <div class="col"><div class="form-check"><input class="form-check-input typeBox" type="checkbox" value="security" id="typeSecurity"><label class="form-check-label" for="typeSecurity">Security</label></div></div>
                                    <div class="col"><div class="form-check"><input class="form-check-input typeBox" type="checkbox" value="performance" id="typePerformance"><label class="form-check-label" for="typePerformance">Performance</label></div></div>
                                    <div class="col"><div class="form-check"><input class="form-check-input typeBox" type="checkbox" value="usability" id="typeUsability"><label class="form-check-label" for="typeUsability">Usability</label></div></div>
                                </div>
                            </div>
                            <div class="col-12 d-flex gap-2">
                                <button class="btn btn-primary" id="btnGenerateMore"><i class="fa-solid fa-plus me-1"></i>Generate</button>
                                <div id="genStatus" class="text-muted"></div>
                            </div>
                        </div>
                        <div id="originalInput" th:text="${input}" style="display:none;"></div>
                        <div id="originalInputType" th:text="${inputType}" style="display:none;"></div>
                    </div>
                </div>

                <div class="card card-glass mb-3">
                    <div class="card-body">
                        <div class="section-title"><i class="fa-solid fa-layer-group me-2"></i>All Results</div>
                        <div id="resultsContainer" class="d-flex flex-column gap-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Parse markdown table
        function parseMarkdownTable(md) {
            if (!md) return null;
            md = md.replace(/```[a-zA-Z]*\n?|```/g, '');
            const lines = md.split('\n').map(l => l.trim());
            for (let i = 0; i < lines.length - 1; i++) {
                const headerLine = lines[i];
                const delimLine = lines[i + 1];
                if (!headerLine.startsWith('|') || !delimLine.startsWith('|')) continue;
                if (!/^\|?\s*:?[-\s|:]+:?\s*\|?$/.test(delimLine)) continue;
                const headers = headerLine.split('|').map(c => c.trim()).filter(c => c.length > 0);
                const rows = [];
                for (let j = i + 2; j < lines.length; j++) {
                    const rowLine = lines[j];
                    if (!rowLine || !rowLine.includes('|')) break;
                    if (!rowLine.startsWith('|')) break;
                    const cells = rowLine.split('|').map(c => c.trim());
                    const cleaned = cells.filter(c => c.length > 0);
                    if (cleaned.length === 0) continue;
                    rows.push(cleaned);
                }
                if (headers.length > 0 && rows.length > 0) {
                    return { headers, rows };
                }
            }
            return null;
        }

        function buildTableEl(parsed) {
            const table = document.createElement('table');
            table.className = 'table table-striped table-hover';
            const thead = document.createElement('thead');
            const thRow = document.createElement('tr');
            parsed.headers.forEach(h => {
                const th = document.createElement('th'); th.textContent = h; thRow.appendChild(th);
            });
            thead.appendChild(thRow);
            const tbody = document.createElement('tbody');
            parsed.rows.forEach(row => {
                const tr = document.createElement('tr');
                parsed.headers.forEach((_, idx) => {
                    const td = document.createElement('td');
                    td.textContent = row[idx] ?? '';
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(thead); table.appendChild(tbody);
            return table;
        }

        function renderInitial() {
            const md = document.getElementById('rawText').textContent;
            const genType = (document.getElementById('generationTypeInitial').textContent || 'test_scenarios').toLowerCase();
            const table = document.getElementById('initialTable');
            const storyDiv = document.getElementById('initialStory');
            if (genType === 'user_story') {
                // Extract story text before Acceptance Criteria
                const idx = md.toLowerCase().indexOf('acceptance criteria');
                const storyText = idx > -1 ? md.substring(0, idx).trim() : md.split('\n\n')[0] || md.split('\n')[0];
                if (storyText) {
                    storyDiv.style.display = 'block';
                    storyDiv.textContent = storyText.trim();
                }
                // Parse acceptance criteria lines into a single-column table
                const criteria = md.split('\n')
                    .map(l => l.trim())
                    .filter(l => /^(\d+\.|[-*]|Given|When|Then)/i.test(l))
                    .map(l => l.replace(/^\d+\.\s*/, '').replace(/^[-*]\s*/, ''))
                    .filter(Boolean);
                const headers = ['Acceptance Criteria'];
                const rows = criteria.length ? criteria.map(c => [c]) : [];
                const parsed = { headers, rows };
                if (rows.length) {
                    const tableEl = buildTableEl(parsed);
                    table.innerHTML = '';
                    table.appendChild(tableEl.querySelector('thead'));
                    table.appendChild(tableEl.querySelector('tbody'));
                    window.__initialAOA = [headers, ...rows];
                } else {
                    table.innerHTML = '<tbody><tr><td class="text-muted">No acceptance criteria detected.</td></tr></tbody>';
                    window.__initialAOA = null;
                }
            } else {
                const parsed = parseMarkdownTable(md);
                if (parsed) {
                    const tableEl = buildTableEl(parsed);
                    table.innerHTML = '';
                    table.appendChild(tableEl.querySelector('thead'));
                    table.appendChild(tableEl.querySelector('tbody'));
                    window.__initialAOA = [parsed.headers, ...parsed.rows];
                } else {
                    table.innerHTML = '<tbody><tr><td class="text-muted">No table detected in initial content.</td></tr></tbody>';
                    window.__initialAOA = null;
                }
            }
        }

        function copyRaw() {
            const text = document.getElementById('rawText').textContent;
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text);
            } else {
                const ta = document.createElement('textarea');
                ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
            }
        }

        function exportInitialCSV() {
            if (!window.__initialAOA) { alert('No table to export.'); return; }
            const ws = XLSX.utils.aoa_to_sheet(window.__initialAOA);
            const csv = XLSX.utils.sheet_to_csv(ws);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const genType = (document.getElementById('generationTypeInitial').textContent || 'test_scenarios').toLowerCase();
            const base = genType === 'user_story' ? 'user-story' : (genType === 'test_cases' ? 'test-cases' : 'test-scenarios');
            const a = document.createElement('a'); a.href = url; a.download = `${base}-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        }

        function printInitial() {
            const text = document.getElementById('rawText').textContent;
            const w = window.open('', '_blank');
            w.document.write('<!DOCTYPE html><html><head><title>Test Scenarios Report</title></head><body>');
            w.document.write('<h1>Test Scenarios Report</h1>');
            w.document.write('<pre style="white-space:pre-wrap;font-family:monospace;">' + text.replace(/</g,'&lt;') + '</pre>');
            w.document.write('</body></html>');
            w.document.close(); w.print();
        }

        function toggleOptionBlocks() {
            const type = document.getElementById('generationType').value;
            const acceptanceWrap = document.getElementById('acceptanceWrap');
            const typesWrap = document.getElementById('typesWrap');
            if (type === 'user_story') { acceptanceWrap.style.display = 'block'; typesWrap.style.display = 'none'; }
            else { acceptanceWrap.style.display = 'none'; typesWrap.style.display = 'block'; }
        }

        function getSelectedTypes() {
            return Array.from(document.querySelectorAll('.typeBox:checked')).map(cb => cb.value);
        }

        async function generateMore() {
            const genStatus = document.getElementById('genStatus');
            genStatus.textContent = 'Generating...';
            const payload = {
                input: document.getElementById('originalInput').textContent,
                inputType: document.getElementById('originalInputType').textContent || 'text',
                generationType: document.getElementById('generationType').value,
                includeAcceptance: document.getElementById('includeAcceptance').checked,
                selectedTypes: getSelectedTypes()
            };
            try {
                const res = await fetch('/api/generate-more', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const text = await res.text();
                appendResultCard(payload, text);
                genStatus.textContent = 'Done';
                setTimeout(() => genStatus.textContent = '', 1500);
            } catch (e) {
                genStatus.textContent = 'Error generating results';
            }
        }

        function appendResultCard(payload, content) {
            const container = document.getElementById('resultsContainer');
            const card = document.createElement('div');
            card.className = 'card card-glass';
            const body = document.createElement('div');
            body.className = 'card-body';

            const title = document.createElement('div');
            title.className = 'result-card-title mb-2';
            const icon = document.createElement('i');
            icon.className = payload.generationType === 'user_story' ? 'fa-solid fa-book-open' : 'fa-solid fa-table';
            const label = document.createElement('span');
            const typeLabel = payload.generationType === 'user_story' ? (payload.includeAcceptance ? 'User Story + Acceptance Criteria' : 'User Story') : (payload.generationType === 'test_cases' ? 'Test Cases' : 'Test Scenarios');
            label.textContent = typeLabel;
            const meta = document.createElement('span'); meta.className = 'badge bg-light text-dark result-badge ms-2'; meta.textContent = new Date().toLocaleString();
            title.appendChild(icon); title.appendChild(label); title.appendChild(meta);
            body.appendChild(title);

            // Try to parse as table first
            const parsed = parseMarkdownTable(content);
            if (parsed) {
                body.appendChild(buildTableEl(parsed));
            } else {
                const pre = document.createElement('pre'); pre.style.whiteSpace = 'pre-wrap'; pre.textContent = content; body.appendChild(pre);
            }

            const actions = document.createElement('div'); actions.className = 'mt-2 d-flex gap-2';
            const copyBtn = document.createElement('button'); copyBtn.className = 'btn btn-sm btn-outline-secondary'; copyBtn.innerHTML = '<i class="fa-regular fa-copy me-1"></i>Copy';
            copyBtn.onclick = () => { if (navigator.clipboard) navigator.clipboard.writeText(content); };
            actions.appendChild(copyBtn);
            body.appendChild(actions);

            card.appendChild(body);
            container.appendChild(card);
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Dynamic titles based on initial generation type
            const genType = (document.getElementById('generationTypeInitial').textContent || 'test_scenarios').toLowerCase();
            const pageHeader = document.getElementById('pageHeader');
            const generatedTitle = document.getElementById('generatedTitle');
            const label = genType === 'user_story' ? 'User Story Generated Successfully' : (genType === 'test_cases' ? 'Test Cases Generated Successfully' : 'Test Scenarios Generated Successfully');
            const genLabel = genType === 'user_story' ? 'Generated User Story' : (genType === 'test_cases' ? 'Generated Test Cases' : 'Generated Test Scenarios');
            pageHeader.textContent = label;
            generatedTitle.textContent = genLabel;

            renderInitial();
            toggleOptionBlocks();
            document.getElementById('generationType').addEventListener('change', toggleOptionBlocks);
            document.getElementById('btnGenerateMore').addEventListener('click', generateMore);
            // Add the initial result card too using actual type
            appendResultCard({ generationType: genType, includeAcceptance: false }, document.getElementById('rawText').textContent);
        });
    </script>
</body>
</html>