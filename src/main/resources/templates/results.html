<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Scenarios Generated - Test Analyst AI Assistant</title>
</head>
<body>
    <h1 class="mb-0">
        <i class="fas fa-check-circle"></i> Test Scenarios Generated Successfully!
    </h1>
    <p>Below are the test scenarios generated based on your input.</p>

    <div id="testConditions" th:text="${testConditions}" style="display:none;"></div>

    <h4 class="section-title">
        <i class="fas fa-list-check"></i> Generated Test Scenarios
    </h4>
    <div class="table-responsive">
        <table class="table table-bordered table-striped" id="conditionsTable"></table>
    </div>

    <div class="d-flex justify-content-between align-items-center mt-3">
        <button class="btn btn-primary" onclick="copyToClipboard()">
            <i class="fas fa-copy"></i> Copy All
        </button>
        <button class="btn btn-success" onclick="downloadCSV()">
            <i class="fas fa-download"></i> Download CSV
        </button>
        <button class="btn btn-primary" onclick="printReport()">
            <i class="fas fa-print"></i> Print
        </button>
        <a href="/" class="btn btn-secondary">
            <i class="fas fa-plus"></i> Generate New Test Scenarios
        </a>
    </div>

    <script>
        let parsedTableData = null;

        function parseMarkdownTable(md) {
            if (!md) return null;
            md = md.replace(/```[a-zA-Z]*\n?|```/g, '');
            const lines = md.split('\n').map(l => l.trim());
            for (let i = 0; i < lines.length - 1; i++) {
                const headerLine = lines[i];
                const delimLine = lines[i + 1];
                if (!headerLine.startsWith('|') || !delimLine.startsWith('|')) continue;
                if (!/^\|?\s*:?[-\s|:]+:?\s*\|?$/.test(delimLine)) continue;
                const headers = headerLine.split('|').map(c => c.trim()).filter(c => c.length > 0);
                const rows = [];
                for (let j = i + 2; j < lines.length; j++) {
                    const rowLine = lines[j];
                    if (!rowLine || !rowLine.includes('|')) break;
                    if (!rowLine.startsWith('|')) break;
                    const cells = rowLine.split('|').map(c => c.trim());
                    const cleaned = cells.filter(c => c.length > 0);
                    if (cleaned.length === 0) continue;
                    rows.push(cleaned);
                }
                if (headers.length > 0 && rows.length > 0) {
                    return { headers, rows };
                }
            }
            return null;
        }

        function renderConditionsOnlyTable() {
            const table = document.getElementById('conditionsTable');
            const md = document.getElementById('testConditions').textContent || '';
            const parsed = parseMarkdownTable(md);
            let scenarios = [];
            if (parsed) {
                const idx = parsed.headers.findIndex(h => /(test\s*scenario|test\s*condition)/i.test(h));
                if (idx !== -1) {
                    scenarios = parsed.rows.map(r => (r[idx] || '').trim()).filter(Boolean);
                } else {
                    scenarios = parsed.rows.map(r => r.find(c => c && c.trim().length > 0) || '').filter(Boolean);
                }
            } else {
                scenarios = md.split('\n')
                    .map(l => l.trim())
                    .filter(l => l && !/TEST (CONDITIONS|SCENARIOS)|INPUT ANALYSIS|TOTAL|TIP/i.test(l) && (/^✓/.test(l) || /^[-*]\s+/.test(l) || /^\d+\./.test(l)))
                    .map(l => l.replace(/^✓\s*/, ''))
                    .map(l => l.replace(/^[-*]\s+/, ''))
                    .map(l => l.replace(/^[A-Z]+\d+\s*:\s*/, ''))
                    .filter(l => l.length > 0);
            }

            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            const th = document.createElement('th');
            th.textContent = 'Test Scenario';
            headerRow.appendChild(th);
            thead.appendChild(headerRow);

            const tbody = document.createElement('tbody');
            scenarios.forEach(c => {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.textContent = c;
                tr.appendChild(td);
                tbody.appendChild(tr);
            });

            table.innerHTML = '';
            table.appendChild(thead);
            table.appendChild(tbody);

            parsedTableData = [['Test Scenario'], ...scenarios.map(c => [c])];
        }

        function copyToClipboard() {
            const text = document.getElementById('testConditions').textContent;
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).catch(() => fallbackCopy(text));
            } else {
                fallbackCopy(text);
            }
        }

        function fallbackCopy(text) {
            const ta = document.createElement('textarea');
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
        }

        function downloadCSV() {
            if (!parsedTableData) renderConditionsOnlyTable();
            const rows = parsedTableData.map(r => r.map(cell => '"' + String(cell).replace(/"/g, '""') + '"').join(','));
            const csv = rows.join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `test-scenarios-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function printReport() {
            const text = document.getElementById('testConditions').textContent;
            const w = window.open('', '_blank');
            w.document.write('<!DOCTYPE html><html><head><title>Test Scenarios Report</title></head><body>');
            w.document.write('<h1>Test Scenarios Report</h1>');
            w.document.write('<pre style="white-space:pre-wrap;font-family:monospace;">' + text.replace(/</g,'&lt;') + '</pre>');
            w.document.write('</body></html>');
            w.document.close();
            w.print();
        }

        document.addEventListener('DOMContentLoaded', renderConditionsOnlyTable);
    </script>
</body>
</html>