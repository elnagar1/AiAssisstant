<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intelligent Performance Test Scenario Generator</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --main-font: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        }
        body, .form-control, .form-select, .btn, .card, .navbar, .nav, .tab-pane, .alert, .dropdown-menu, .modal-content {
            font-family: var(--main-font) !important;
        }
    </style>
</head>
<body>
    <div class="container mt-5 mb-5">
        <div class="header text-center py-4 bg-primary text-white rounded-top shadow-sm">
            <h1 class="display-4">ü§ñ Intelligent Performance Test Scenario Generator</h1>
            <p class="lead">Generate performance test scenarios using AI</p>
        </div>

        <div class="content bg-white p-4 rounded-bottom shadow-sm">
            <!-- Loading Indicator -->
            <div id="loading" class="loading-spinner text-center py-5" style="display:none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Generating performance test plan. Please wait...</p>
            </div>

            <!-- Error Message -->
            <div id="errorMessage" class="error-message alert alert-danger" role="alert" style="display:none;"></div>

            <!-- Form Section for Generating a New Performance Test Plan -->
            <div class="form-section card card-body mb-4">
                <h3 class="card-title text-primary text-center mb-4">Generate New Performance Test Plan</h3>
                <form id="generatePlanForm">
                    <div class="mb-3">
                        <label for="systemName" class="form-label">System Name:</label>
                        <input type="text" id="systemName" name="systemName" class="form-control" placeholder="e.g., E-commerce Platform" required>
                    </div>
                    <div class="mb-3">
                        <label for="applicationDescription" class="form-label">Application Description:</label>
                        <textarea id="applicationDescription" name="applicationDescription" rows="4" class="form-control" placeholder="Briefly describe your application and its key functionalities, e.g., 'An online retail application allowing users to browse products, add to cart, and checkout. It handles user authentication and payment processing.'" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="keyFeatures" class="form-label">Key Features/Modules to Test:</label>
                        <textarea id="keyFeatures" name="keyFeatures" rows="3" class="form-control" placeholder="List the most critical features or modules you want to performance test, e.g., 'Product Catalog, User Login, Shopping Cart, Checkout Process, Search Functionality.'" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="loadCharacteristics" class="form-label">Expected Load Characteristics:</label>
                        <textarea id="loadCharacteristics" name="loadCharacteristics" rows="3" class="form-control" placeholder="Describe the expected user load, e.g., 'Typical load: 1000 concurrent users, Peak load: 5000 concurrent users during promotions. Average transaction rate: 50 TPS, Peak: 200 TPS.'" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="performanceGoals" class="form-label">Performance Goals (e.g., Response Time, Throughput):</label>
                        <textarea id="performanceGoals" name="performanceGoals" rows="3" class="form-control" placeholder="Specify your performance objectives, e.g., 'All critical transactions should have a response time under 3 seconds. System should sustain 200 TPS with 99% uptime.'" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="additionalNotes" class="form-label">Additional Notes/Considerations:</label>
                        <textarea id="additionalNotes" name="additionalNotes" rows="3" class="form-control" placeholder="Any other relevant information, e.g., 'Database is PostgreSQL, running on AWS EC2. Application uses microservices architecture.'"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Generate Performance Plan</button>
                </form>
            </div>

            <!-- Results Section for Displaying Generated Plan -->
            <div id="results" class="results" style="display:none;">
                <h3 class="text-primary text-center mb-4">Generated Performance Test Plan</h3>
                <div id="planOverview" class="card mb-4 shadow-sm">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h4 class="mb-0" id="planName"></h4>
                        <span class="badge bg-info">Comprehensive Plan</span>
                    </div>
                    <div class="card-body">
                        <div class="row g-3 mb-3">
                            <div class="col-md-3">
                                <div class="fw-bold text-muted">Plan ID</div>
                                <div id="planId"></div>
                            </div>
                            <div class="col-md-3">
                                <div class="fw-bold text-muted">System</div>
                                <div id="systemOutput"></div>
                            </div>
                            <div class="col-md-3">
                                <div class="fw-bold text-muted">Created</div>
                                <div id="createdDate"></div>
                            </div>
                            <div class="col-md-3">
                                <div class="fw-bold text-muted">Estimated Duration</div>
                                <div id="estimatedDuration"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="scenariosList"></div>
                <div class="d-flex justify-content-center gap-3 mt-4">
                    <button type="button" class="btn btn-success" onclick="copyToClipboard()">Copy Plan to Clipboard</button>
                    <a href="/" class="btn btn-secondary">Back to Home</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Jira Analysis Tab -->
    <div class="container mt-5 mb-5">
        <div class="header text-center py-4 bg-success text-white rounded-top shadow-sm">
            <h1 class="display-4">üêõ Jira Bug Analysis</h1>
            <p class="lead">Connect to Jira and analyze bugs for data quality issues</p>
        </div>

        <div class="content bg-white p-4 rounded-bottom shadow-sm">
            <!-- Jira Connection Form -->
            <div class="form-section card card-body mb-4">
                <h3 class="card-title text-success text-center mb-4">Connect to Jira Project</h3>
                <form id="jiraConnectionForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="jiraUrl" class="form-label">Jira URL:</label>
                                <input type="url" id="jiraUrl" name="jiraUrl" class="form-control" placeholder="https://your-domain.atlassian.net" required>
                            </div>
                            <div class="mb-3">
                                <label for="projectKey" class="form-label">Project Key:</label>
                                <input type="text" id="projectKey" name="projectKey" class="form-control" placeholder="e.g., PROJ" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="username" class="form-label">Username/Email:</label>
                                <input type="text" id="username" name="username" class="form-control" placeholder="your-email@domain.com" required>
                            </div>
                            <div class="mb-3">
                                <label for="apiToken" class="form-label">API Token:</label>
                                <input type="password" id="apiToken" name="apiToken" class="form-control" placeholder="Your Jira API token" required>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success w-100">Connect & Analyze Bugs</button>
                </form>
            </div>

            <!-- Loading Indicator for Jira -->
            <div id="jiraLoading" class="loading-spinner text-center py-5" style="display:none;">
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Connecting to Jira and analyzing bugs. Please wait...</p>
            </div>

            <!-- Error Message for Jira -->
            <div id="jiraErrorMessage" class="error-message alert alert-danger" role="alert" style="display:none;"></div>

            <!-- Jira Analysis Results -->
            <div id="jiraResults" class="results" style="display:none;">
                <h3 class="text-success text-center mb-4">Bug Analysis Results</h3>
                
                <!-- Summary Statistics -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center bg-light">
                            <div class="card-body">
                                <h4 class="text-primary" id="totalBugs">0</h4>
                                <p class="text-muted mb-0">Total Bugs</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center bg-light">
                            <div class="card-body">
                                <h4 class="text-warning" id="dataIssues">0</h4>
                                <p class="text-muted mb-0">Data Issues</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center bg-light">
                            <div class="card-body">
                                <h4 class="text-danger" id="spellingErrors">0</h4>
                                <p class="text-muted mb-0">Spelling Errors</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center bg-light">
                            <div class="card-body">
                                <h4 class="text-info" id="grammarIssues">0</h4>
                                <p class="text-muted mb-0">Grammar Issues</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Issues by Category -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header bg-warning text-white">
                                <h5 class="mb-0">Data Quality Issues</h5>
                            </div>
                            <div class="card-body">
                                <div id="dataIssuesList"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header bg-danger text-white">
                                <h5 class="mb-0">Language Issues</h5>
                            </div>
                            <div class="card-body">
                                <div id="languageIssuesList"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Bug List -->
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Detailed Bug Analysis</h5>
                    </div>
                    <div class="card-body">
                        <div id="detailedBugList"></div>
                    </div>
                </div>

                <div class="d-flex justify-content-center gap-3 mt-4">
                    <button type="button" class="btn btn-success" onclick="exportJiraAnalysis()">Export Analysis</button>
                    <button type="button" class="btn btn-warning" onclick="refreshJiraAnalysis()">Refresh Analysis</button>
                    <a href="/" class="btn btn-secondary">Back to Home</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('generatePlanForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            
            const formData = new FormData(event.target);
            const requestBody = {
                systemName: formData.get('systemName'),
                applicationDescription: formData.get('applicationDescription'),
                keyFeatures: formData.get('keyFeatures'),
                loadCharacteristics: formData.get('loadCharacteristics'),
                performanceGoals: formData.get('performanceGoals'),
                additionalNotes: formData.get('additionalNotes')
            };

            try {
                const response = await fetch('/api/performance/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to generate plan');
                }

                const plan = await response.json();
                displayResults(plan);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('errorMessage').innerText = `Error: ${error.message}`;
                document.getElementById('errorMessage').style.display = 'block';
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        });

        function displayResults(plan) {
            document.getElementById('planName').innerText = plan.planName;
            document.getElementById('planId').innerText = plan.planId;
            document.getElementById('systemOutput').innerText = plan.systemName;
            document.getElementById('createdDate').innerText = new Date(plan.createdDate).toLocaleString('en-US');
            document.getElementById('estimatedDuration').innerText = plan.estimatedDuration;

            const scenariosList = document.getElementById('scenariosList');
            scenariosList.innerHTML = `
                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">${plan.planName}</h4>
                        <span class="badge bg-info">Comprehensive Plan</span>
                    </div>
                    <div class="card-body">
                        <div class="row g-3 mb-3">
                            <div class="col-md-3">
                                <div class="fw-bold text-muted">Plan ID</div>
                                <div>${plan.planId}</div>
                            </div>
                            <div class="col-md-3">
                                <div class="fw-bold text-muted">System</div>
                                <div>${plan.systemName}</div>
                            </div>
                            <div class="col-md-3">
                                <div class="fw-bold text-muted">Created</div>
                                <div>${new Date(plan.createdDate).toLocaleString('en-US')}</div>
                            </div>
                            <div class="col-md-3">
                                <div class="fw-bold text-muted">Estimated Duration</div>
                                <div>${plan.estimatedDuration}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            plan.scenarios.forEach(scenario => {
                const scenarioCard = document.createElement('div');
                scenarioCard.className = 'card mb-3 shadow-sm';
                scenarioCard.innerHTML = `
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="card-title mb-0">${scenario.scenarioName}</h5>
                            <span class="badge bg-secondary">${getScenarioTypeName(scenario.scenarioType)}</span>
                        </div>
                        <p class="card-text text-muted">${scenario.description}</p>
                        <div class="row g-2 mb-3">
                            <div class="col-md-3"><div class="fw-bold text-muted">Target Users</div><div>${scenario.targetUsers}</div></div>
                            <div class="col-md-3"><div class="fw-bold text-muted">Ramp-up Time</div><div>${scenario.rampUpTime}</div></div>
                            <div class="col-md-3"><div class="fw-bold text-muted">Test Duration</div><div>${scenario.testDuration}</div></div>
                            <div class="col-md-3"><div class="fw-bold text-muted">Priority</div><div>${scenario.priority}/5</div></div>
                        </div>
                        <h6 class="text-primary">Test Steps:</h6>
                        <ul class="list-group list-group-flush mb-3">
                            ${scenario.testSteps.map(step => `<li class="list-group-item">${step}</li>`).join('')}
                        </ul>
                        <h6 class="text-primary">Success Criteria:</h6>
                        <ul class="list-group list-group-flush">
                            ${scenario.successCriteria.map(criteria => `<li class="list-group-item">${criteria}</li>`).join('')}
                        </ul>
                    </div>
                `;
                scenariosList.appendChild(scenarioCard);
            });

            document.getElementById('results').style.display = 'block';
        }

        function getScenarioTypeName(type) {
            const types = {
                'STRESS': 'Stress Test',
                'SOAK': 'Soak Test',
                'VOLUME': 'Volume Test',
                'SPIKE': 'Spike Test',
                'SCALABILITY': 'Scalability Test'
            };
            return types[type] || type;
        }

        async function copyToClipboard() {
            const plan = JSON.parse(localStorage.getItem('perfPlan'));
            if (plan) {
                const planText = JSON.stringify(plan, null, 2);
                try {
                    await navigator.clipboard.writeText(planText);
                    alert('Performance plan copied to clipboard!');
                } catch (err) {
                    console.error('Failed to copy:', err);
                    alert('Failed to copy performance plan.');
                }
            }
        }

        // Script for initial load check for existing plan (if coming from a redirect or refresh)
        document.addEventListener('DOMContentLoaded', () => {
            const savedPlan = localStorage.getItem('perfPlan');
            if (savedPlan) {
                try {
                    const plan = JSON.parse(savedPlan);
                    displayResults(plan);
                } catch (e) {
                    console.error("Error parsing stored plan:", e);
                    document.getElementById('errorMessage').innerText = 'Error loading saved plan. Please generate a new one.';
                    document.getElementById('errorMessage').style.display = 'block';
                }
            }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>