<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Results Generated - Test Analyst AI Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0b1220 0%, #020617 100%);
            min-height: 100vh;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            color: #e5e7eb;
        }
        .page-container { padding: 24px 12px; }
        .card-glass {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,.4);
            color: #e5e7eb;
        }
        .card-header-gradient {
            background: linear-gradient(45deg, #22c55e, #3b82f6);
            color: #fff;
            border-radius: 16px 16px 0 0 !important;
            padding: 20px;
            text-align: center;
        }
        .section-title { border-bottom: 1px solid #334155; padding-bottom: 10px; margin-bottom: 16px; color: #e2e8f0; }
        .input-preview { background: #0b1220; border-left: 4px solid #3b82f6; border-radius: 12px; padding: 16px; white-space: pre-wrap; color: #e5e7eb; }
        .copy-btn { position: absolute; top: 10px; right: 10px; }
        .result-badge { font-size: .8rem; }
        .result-card-title { display: flex; align-items: center; gap: 8px; }
        .table { color: #e5e7eb; }
        .table thead th { background: #0f172a; color: #cbd5e1; border-color: #334155; }
        .table tbody td { border-color: #334155; }
        .pill { display: inline-block; padding: 4px 10px; border-radius: 999px; font-size: .8rem; color: #e5e7eb; background: rgba(51,65,85,.6); margin-right: 6px; }
        .form-select, .form-control { background-color: #0f172a; color: #e5e7eb; border-color: #334155; }
        .form-select:focus, .form-control:focus { background-color: #0f172a; color: #e5e7eb; border-color: #3b82f6; box-shadow: 0 0 0 .2rem rgba(59,130,246,.25); }
        .btn-outline-secondary { color: #e5e7eb; border-color: #475569; }
        .btn-outline-secondary:hover { background: #1f2937; color: #fff; }
        .btn-outline-primary { color: #93c5fd; border-color: #60a5fa; }
        .btn-outline-primary:hover { background: #1d4ed8; color: #fff; }
        .btn-success { background: #16a34a; border-color: #16a34a; }
        .btn-primary { background: #2563eb; border-color: #2563eb; }
    </style>
</head>
<body>
    <div class="container page-container">
        <div class="row justify-content-center">
            <div class="col-xl-10 col-lg-11">
                <div class="d-flex justify-content-end mb-2">
                    <ul class="nav nav-pills" id="langTabs" role="tablist">
                        <li class="nav-item" role="presentation"><button class="nav-link active" data-lang="en" type="button">EN</button></li>
                        <li class="nav-item ms-2" role="presentation"><button class="nav-link" data-lang="ar" type="button">AR</button></li>
                    </ul>
                </div>
                <div class="card card-glass mb-3">
                    <div class="card-header-gradient">
                        <h1 class="h3 mb-0"><i class="fa-solid fa-circle-check me-2"></i> <span id="pageHeader">Test Scenarios Generated Successfully</span></h1>
                        <div class="small opacity-75 mt-1">AI-powered analysis complete</div>
                    </div>
                    <div class="card-body">
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            <span class="pill">Input: <span class="fw-semibold" th:text="${inputType}">Text</span></span>
                            <span class="pill" th:if="${fileName}">File: <span class="fw-semibold" th:text="${fileName}"></span></span>
                        </div>
                        <div class="section-title"><i class="fa-solid fa-circle-info me-2"></i><span id="labelInputPreview">Input Preview</span></div>
                        <div class="input-preview" th:text="${input}"></div>
                    </div>
                </div>

                <div class="card card-glass mb-3">
                    <div class="card-body position-relative">
                        <div class="section-title"><i class="fa-solid fa-list-check me-2"></i><span id="generatedTitle">Generated Test Scenarios</span></div>
                        <button id="btnCopyRaw" class="btn btn-sm btn-outline-secondary copy-btn" onclick="copyRaw()"><i class="fa-regular fa-copy me-1"></i><span data-i18n="copyRaw">Copy Raw</span></button>
                        <div id="rawText" th:text="${testConditions}" style="display:none;"></div>
                        <div id="generationTypeInitial" th:text="${generationType}" style="display:none;"></div>
                        <div id="initialStory" class="input-preview mb-3" style="display:none;"></div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="initialTable"></table>
                        </div>
                        <div class="mt-3 d-flex flex-wrap gap-2">
                            <button id="btnExportCSV" class="btn btn-success" onclick="exportInitialCSV()"><i class="fa-solid fa-file-csv me-1"></i><span data-i18n="exportCsv">Export CSV</span></button>
                            <button id="btnPrint" class="btn btn-outline-primary" onclick="printInitial()"><i class="fa-solid fa-print me-1"></i><span data-i18n="print">Print</span></button>
                            <a id="btnGenerateNew" href="/" class="btn btn-outline-secondary"><i class="fa-solid fa-plus me-1"></i><span data-i18n="generateNew">Generate New</span></a>
                        </div>
                    </div>
                </div>

                <div class="card card-glass mb-3">
                    <div class="card-body">
                        <div class="section-title"><i class="fa-solid fa-wand-magic-sparkles me-2"></i><span id="labelAddMore">Add More Results</span></div>
                        <div class="row g-3 align-items-end">
                            <div class="col-md-4">
                                <label class="form-label" id="labelWhatNeed">What do you need?</label>
                                <select id="generationType" class="form-select">
                                    <option value="user_story">User Story</option>
                                    <option value="test_cases" selected>Test Cases</option>
                                </select>
                            </div>
                            <div class="col-md-4" id="acceptanceWrap" style="display:none;">
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" id="includeAcceptance">
                                    <label class="form-check-label" id="labelIncludeAC" for="includeAcceptance">Include Acceptance Criteria</label>
                                </div>
                            </div>
                            <div class="col-12" id="typesWrap">
                                <label class="form-label" id="labelSelectTypes">Select desired types (optional):</label>
                                <div class="row row-cols-2 row-cols-md-3 g-2">
                                    <div class="col"><div class="form-check"><input class="form-check-input typeBox" type="checkbox" value="functional" id="typeFunctional"><label class="form-check-label" for="typeFunctional">Functional</label></div></div>
                                    <div class="col"><div class="form-check"><input class="form-check-input typeBox" type="checkbox" value="negative" id="typeNegative"><label class="form-check-label" for="typeNegative">Negative</label></div></div>
                                    <div class="col"><div class="form-check"><input class="form-check-input typeBox" type="checkbox" value="boundary" id="typeBoundary"><label class="form-check-label" for="typeBoundary">Boundary</label></div></div>
                                    <div class="col"><div class="form-check"><input class="form-check-input typeBox" type="checkbox" value="security" id="typeSecurity"><label class="form-check-label" for="typeSecurity">Security</label></div></div>
                                    <div class="col"><div class="form-check"><input class="form-check-input typeBox" type="checkbox" value="performance" id="typePerformance"><label class="form-check-label" for="typePerformance">Performance</label></div></div>
                                    <div class="col"><div class="form-check"><input class="form-check-input typeBox" type="checkbox" value="usability" id="typeUsability"><label class="form-check-label" for="typeUsability">Usability</label></div></div>
                                </div>
                            </div>
                            <div class="col-12 d-flex gap-2">
                                <button class="btn btn-primary" id="btnGenerateMore"><i class="fa-solid fa-plus me-1"></i><span data-i18n="generate">Generate</span></button>
                                <div id="genStatus" class="text-muted"></div>
                            </div>
                        </div>
                        <div id="originalInput" th:text="${input}" style="display:none;"></div>
                        <div id="originalInputType" th:text="${inputType}" style="display:none;"></div>
                    </div>
                </div>

                <div class="card card-glass mb-3">
                    <div class="card-body">
                        <div class="section-title"><i class="fa-solid fa-layer-group me-2"></i><span id="labelAllResults">All Results</span></div>
                        <ul class="nav nav-tabs" id="resultsTabs" role="tablist"></ul>
                        <div class="tab-content pt-3" id="resultsTabContent"></div>
                        <div class="mt-3 d-flex gap-2">
                            <button id="btnExportActiveCSV" class="btn btn-success btn-sm"><i class="fa-solid fa-file-csv me-1"></i>Export Active CSV</button>
                            <button id="btnExportActiveXLSX" class="btn btn-outline-success btn-sm"><i class="fa-solid fa-file-excel me-1"></i>Export Active Excel</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const I18N = {
            en: {
                pageHeader: 'Test Scenarios Generated Successfully',
                inputPreview: 'Input Preview',
                generatedUserStory: 'Generated User Story',
                generatedTestCases: 'Generated Test Cases',
                generatedTestScenarios: 'Generated Test Scenarios',
                copyRaw: 'Copy Raw',
                exportCsv: 'Export CSV',
                print: 'Print',
                generateNew: 'Generate New',
                addMore: 'Add More Results',
                whatNeed: 'What do you need?',
                includeAC: 'Include Acceptance Criteria',
                selectTypes: 'Select desired types (optional):',
                generate: 'Generate',
                allResults: 'All Results'
            },
            ar: {
                pageHeader: 'تم إنشاء سيناريوهات الاختبار بنجاح',
                inputPreview: 'معاينة الإدخال',
                generatedUserStory: 'قصة المستخدم المُولّدة',
                generatedTestCases: 'حالات الاختبار المُولّدة',
                generatedTestScenarios: 'سيناريوهات الاختبار المُولّدة',
                copyRaw: 'نسخ النص',
                exportCsv: 'تصدير CSV',
                print: 'طباعة',
                generateNew: 'توليد جديد',
                addMore: 'إضافة نتائج أخرى',
                whatNeed: 'ماذا تحتاج؟',
                includeAC: 'تضمين معايير القبول',
                selectTypes: 'اختر الأنواع المطلوبة (اختياري):',
                generate: 'توليد',
                allResults: 'كل النتائج'
            }
        };

        function applyLang(lang) {
            const t = I18N[lang] || I18N.en;
            const genType = (document.getElementById('generationTypeInitial').textContent || 'test_scenarios').toLowerCase();
            document.getElementById('pageHeader').textContent = t.pageHeader;
            document.getElementById('labelInputPreview').textContent = t.inputPreview;
            document.getElementById('generatedTitle').textContent = genType === 'user_story' ? t.generatedUserStory : (genType === 'test_cases' ? t.generatedTestCases : t.generatedTestScenarios);
            document.getElementById('btnCopyRaw').querySelector('[data-i18n="copyRaw"]').textContent = t.copyRaw;
            document.getElementById('btnExportCSV').querySelector('[data-i18n="exportCsv"]').textContent = t.exportCsv;
            document.getElementById('btnPrint').querySelector('[data-i18n="print"]').textContent = t.print;
            document.getElementById('btnGenerateNew').querySelector('[data-i18n="generateNew"]').textContent = t.generateNew;
            document.getElementById('labelAddMore').textContent = t.addMore;
            document.getElementById('labelWhatNeed').textContent = t.whatNeed;
            document.getElementById('labelIncludeAC').textContent = t.includeAC;
            document.getElementById('labelSelectTypes').textContent = t.selectTypes;
            document.getElementById('btnGenerateMore').querySelector('[data-i18n="generate"]').textContent = t.generate;
            document.getElementById('labelAllResults').textContent = t.allResults;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
        }
        // Parse markdown table
        function parseMarkdownTable(md) {
            if (!md) return null;
            md = md.replace(/```[a-zA-Z]*\n?|```/g, '');
            const lines = md.split('\n').map(l => l.trim());
            for (let i = 0; i < lines.length - 1; i++) {
                const headerLine = lines[i];
                const delimLine = lines[i + 1];
                if (!headerLine.startsWith('|') || !delimLine.startsWith('|')) continue;
                if (!/^\|?\s*:?[-\s|:]+:?\s*\|?$/.test(delimLine)) continue;
                const headers = headerLine.split('|').map(c => c.trim()).filter(c => c.length > 0);
                const rows = [];
                for (let j = i + 2; j < lines.length; j++) {
                    const rowLine = lines[j];
                    if (!rowLine || !rowLine.includes('|')) break;
                    if (!rowLine.startsWith('|')) break;
                    const cells = rowLine.split('|').map(c => c.trim());
                    const cleaned = cells.filter(c => c.length > 0);
                    if (cleaned.length === 0) continue;
                    rows.push(cleaned);
                }
                if (headers.length > 0 && rows.length > 0) {
                    return { headers, rows };
                }
            }
            return null;
        }

        function buildTableEl(parsed) {
            const table = document.createElement('table');
            table.className = 'table table-striped table-hover';
            const thead = document.createElement('thead');
            const thRow = document.createElement('tr');
            parsed.headers.forEach(h => {
                const th = document.createElement('th'); th.textContent = h; thRow.appendChild(th);
            });
            thead.appendChild(thRow);
            const tbody = document.createElement('tbody');
            parsed.rows.forEach(row => {
                const tr = document.createElement('tr');
                parsed.headers.forEach((_, idx) => {
                    const td = document.createElement('td');
                    td.textContent = row[idx] ?? '';
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(thead); table.appendChild(tbody);
            return table;
        }

        function tableToAOA(tableEl) {
            const aoa = [];
            const headCells = Array.from(tableEl.querySelectorAll('thead th')).map(th => th.textContent);
            if (headCells.length) aoa.push(headCells);
            Array.from(tableEl.querySelectorAll('tbody tr')).forEach(tr => {
                const row = Array.from(tr.children).map(td => td.textContent);
                aoa.push(row);
            });
            return aoa.length > 1 ? aoa : null;
        }

        function renderInitial() {
            const md = document.getElementById('rawText').textContent;
            const genType = (document.getElementById('generationTypeInitial').textContent || 'test_scenarios').toLowerCase();
            const table = document.getElementById('initialTable');
            const storyDiv = document.getElementById('initialStory');
            if (genType === 'user_story') {
                // Extract story text before Acceptance Criteria blocks
                const lower = md.toLowerCase();
                const acIndex = lower.indexOf('acceptance criteria');
                const storyText = acIndex > -1 ? md.substring(0, acIndex).trim() : md.split('\n\n')[0] || md.split('\n')[0];
                if (storyText) { storyDiv.style.display = 'block'; storyDiv.textContent = storyText.trim(); }

                // Split into criteria blocks separated by blank lines
                const afterAC = acIndex > -1 ? md.substring(acIndex).split(/\n\n+/) : [];
                const blocks = afterAC
                    .map(b => b.replace(/^Acceptance Criteria:?\s*/i, '').trim())
                    .filter(b => b.length > 0);
                const headers = ['Acceptance Criteria'];
                const rows = blocks.length ? blocks.map(b => [b]) : [];
                const parsed = { headers, rows };
                if (rows.length) {
                    const tableEl = buildTableEl(parsed);
                    table.innerHTML = '';
                    table.appendChild(tableEl.querySelector('thead'));
                    table.appendChild(tableEl.querySelector('tbody'));
                    window.__initialAOA = [headers, ...rows];
                } else {
                    table.innerHTML = '<tbody><tr><td class="text-muted">No acceptance criteria detected.</td></tr></tbody>';
                    window.__initialAOA = null;
                }
            } else {
                const parsed = parseMarkdownTable(md);
                if (parsed) {
                    const tableEl = buildTableEl(parsed);
                    table.innerHTML = '';
                    table.appendChild(tableEl.querySelector('thead'));
                    table.appendChild(tableEl.querySelector('tbody'));
                    window.__initialAOA = [parsed.headers, ...parsed.rows];
                } else {
                    table.innerHTML = '<tbody><tr><td class="text-muted">No table detected in initial content.</td></tr></tbody>';
                    window.__initialAOA = null;
                }
            }
        }

        function copyRaw() {
            const text = document.getElementById('rawText').textContent;
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text);
            } else {
                const ta = document.createElement('textarea');
                ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
            }
        }

        function exportInitialCSV() {
            if (!window.__initialAOA) { alert('No table to export.'); return; }
            const ws = XLSX.utils.aoa_to_sheet(window.__initialAOA);
            const csv = XLSX.utils.sheet_to_csv(ws);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const genType = (document.getElementById('generationTypeInitial').textContent || 'test_scenarios').toLowerCase();
            const base = genType === 'user_story' ? 'user-story' : (genType === 'test_cases' ? 'test-cases' : 'test-scenarios');
            const a = document.createElement('a'); a.href = url; a.download = `${base}-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        }

        function printInitial() {
            const text = document.getElementById('rawText').textContent;
            const w = window.open('', '_blank');
            w.document.write('<!DOCTYPE html><html><head><title>Test Scenarios Report</title></head><body>');
            w.document.write('<h1>Test Scenarios Report</h1>');
            w.document.write('<pre style="white-space:pre-wrap;font-family:monospace;">' + text.replace(/</g,'&lt;') + '</pre>');
            w.document.write('</body></html>');
            w.document.close(); w.print();
        }

        function toggleOptionBlocks() {
            const type = document.getElementById('generationType').value;
            const acceptanceWrap = document.getElementById('acceptanceWrap');
            const typesWrap = document.getElementById('typesWrap');
            if (type === 'user_story') { acceptanceWrap.style.display = 'block'; typesWrap.style.display = 'none'; }
            else { acceptanceWrap.style.display = 'none'; typesWrap.style.display = 'block'; }
        }

        function getSelectedTypes() {
            return Array.from(document.querySelectorAll('.typeBox:checked')).map(cb => cb.value);
        }

        async function generateMore() {
            const genStatus = document.getElementById('genStatus');
            genStatus.textContent = 'Generating...';
            const payload = {
                input: document.getElementById('originalInput').textContent,
                inputType: document.getElementById('originalInputType').textContent || 'text',
                generationType: document.getElementById('generationType').value,
                includeAcceptance: document.getElementById('includeAcceptance').checked,
                selectedTypes: getSelectedTypes()
            };
            try {
                const res = await fetch('/api/generate-more', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const text = await res.text();
                appendResultCard(payload, text);
                genStatus.textContent = 'Done';
                setTimeout(() => genStatus.textContent = '', 1500);
            } catch (e) {
                genStatus.textContent = 'Error generating results';
            }
        }

        function appendResultCard(payload, content) {
            const tabs = document.getElementById('resultsTabs');
            const panes = document.getElementById('resultsTabContent');
            const id = `tab-${Date.now()}-${Math.random().toString(36).slice(2,7)}`;
            const label = payload.generationType === 'user_story' ? (payload.includeAcceptance ? 'User Story + AC' : 'User Story') : (payload.generationType === 'test_cases' ? 'Test Cases' : 'Test Scenarios');

            const tab = document.createElement('li'); tab.className = 'nav-item d-flex align-items-center'; tab.role = 'presentation';
            tab.innerHTML = `<button class="nav-link" id="${id}-tab" data-bs-toggle="tab" data-bs-target="#${id}" type="button" role="tab" aria-controls="${id}" aria-selected="false">${label}</button>
                             <button class="btn btn-sm btn-link text-danger ms-1" title="Close" data-close-tab="${id}"><i class="fa-solid fa-xmark"></i></button>`;
            tabs.appendChild(tab);

            const pane = document.createElement('div'); pane.className = 'tab-pane fade'; pane.id = id; pane.role = 'tabpanel'; pane.setAttribute('aria-labelledby', `${id}-tab`);

            const header = document.createElement('div'); header.className = 'd-flex align-items-center mb-2 result-card-title';
            const icon = document.createElement('i'); icon.className = payload.generationType === 'user_story' ? 'fa-solid fa-book-open me-2' : 'fa-solid fa-table me-2';
            const time = document.createElement('span'); time.className = 'badge bg-light text-dark result-badge ms-2'; time.textContent = new Date().toLocaleString();
            header.appendChild(icon); header.appendChild(document.createTextNode(label)); header.appendChild(time);
            pane.appendChild(header);

            const parsed = parseMarkdownTable(content);
            if (parsed) {
                const tbl = buildTableEl(parsed);
                tbl.setAttribute('data-table', 'true');
                pane.appendChild(tbl);
            } else {
                const pre = document.createElement('pre'); pre.style.whiteSpace = 'pre-wrap'; pre.textContent = content; pane.appendChild(pre);
            }

            const actions = document.createElement('div'); actions.className = 'mt-2 d-flex gap-2';
            const copyBtn = document.createElement('button'); copyBtn.className = 'btn btn-sm btn-outline-secondary'; copyBtn.innerHTML = '<i class="fa-regular fa-copy me-1"></i>Copy';
            copyBtn.onclick = () => { if (navigator.clipboard) navigator.clipboard.writeText(content); };
            actions.appendChild(copyBtn);
            pane.appendChild(actions);

            panes.appendChild(pane);

            // Activate the newly added tab
            const triggerEl = tab.querySelector('button');
            const tabObj = new bootstrap.Tab(triggerEl);
            tabObj.show();

            // Close handler
            tab.querySelector('[data-close-tab]').addEventListener('click', (e) => {
                e.stopPropagation();
                const targetId = e.currentTarget.getAttribute('data-close-tab');
                const paneEl = document.getElementById(targetId);
                const btnEl = document.getElementById(`${targetId}-tab`);
                if (paneEl) paneEl.remove();
                if (tab) tab.remove();
                // Activate last tab if any
                const lastBtn = document.querySelector('#resultsTabs .nav-link:last-of-type');
                if (lastBtn) { new bootstrap.Tab(lastBtn).show(); }
            });
        }

        // Export active tab content
        function exportActive(format) {
            const activePane = document.querySelector('#resultsTabContent .tab-pane.active');
            if (!activePane) { alert('No active tab'); return; }
            const tableEl = activePane.querySelector('[data-table="true"]');
            if (!tableEl) { alert('No table data in active tab'); return; }
            const aoa = tableToAOA(tableEl);
            if (!aoa) { alert('No table data in active tab'); return; }
            if (format === 'csv') {
                const ws = XLSX.utils.aoa_to_sheet(aoa);
                const csv = XLSX.utils.sheet_to_csv(ws);
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `tab-export-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            } else {
                const ws = XLSX.utils.aoa_to_sheet(aoa);
                const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
                XLSX.writeFile(wb, `tab-export-${new Date().toISOString().split('T')[0]}.xlsx`);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Dynamic titles based on initial generation type
            const genType = (document.getElementById('generationTypeInitial').textContent || 'test_scenarios').toLowerCase();
            const pageHeader = document.getElementById('pageHeader');
            const generatedTitle = document.getElementById('generatedTitle');
            const label = genType === 'user_story' ? 'User Story Generated Successfully' : (genType === 'test_cases' ? 'Test Cases Generated Successfully' : 'Test Scenarios Generated Successfully');
            const genLabel = genType === 'user_story' ? 'Generated User Story' : (genType === 'test_cases' ? 'Generated Test Cases' : 'Generated Test Scenarios');
            pageHeader.textContent = label;
            generatedTitle.textContent = genLabel;

            renderInitial();
            toggleOptionBlocks();
            document.getElementById('generationType').addEventListener('change', toggleOptionBlocks);
            document.getElementById('btnGenerateMore').addEventListener('click', generateMore);
            // Seed tabs with initial result
            appendResultCard({ generationType: genType, includeAcceptance: false }, document.getElementById('rawText').textContent);

            // Language switching
            document.querySelectorAll('#langTabs .nav-link').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#langTabs .nav-link').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    applyLang(btn.getAttribute('data-lang'));
                });
            });
            applyLang('en');
        });
    </script>
</body>
</html>